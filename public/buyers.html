<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Buyers List</title>
  <style>
    body { font:14px system-ui, sans-serif; margin:0; padding:20px; }
    h1 { margin-bottom:20px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:20px; }
    table { border-collapse:collapse; width:100%; font-size:14px; }
    th, td { padding:8px 10px; border-bottom:1px solid #ddd; text-align:left; }
    th { background:#f3f4f6; }
    tr:hover { background:#f9fafb; }
    button { padding:6px 12px; border-radius:6px; border:1px solid #bbb; background:#b91c1c; color:#fff; cursor:pointer; }
    button:hover { background:#991b1b; }
  </style>
</head>
<body>
  <div id="nav-placeholder"></div>
  <h1>Buyers List</h1>
  <div class="card">
    <input id="filter" placeholder="Filter buyers..." style="padding:6px 10px;width:250px">
    <button id="exportCsv">Export CSV</button>
  </div>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>City</th>
          <th>State</th>
          <th>VIP</th>
          <th>Contacted</th>
        </tr>
      </thead>
      <tbody id="buyersTable"></tbody>
    </table>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gvrpmexbyynaikwiijtz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2cnBtZXhieXluYWlrd2lpanR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNzU4NTIsImV4cCI6MjA3Mjg1MTg1Mn0.Crj9RyWIbhQuzUqlf8FQW1A66jVcxa2p9QtolfRLHFY";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchBuyers() {
      const { data, error } = await supabase
        .from("buyers_list")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        return [];
      }
      return data;
    }

    async function toggleVip(id, vip) {
      await supabase.from("buyers_list").update({ vip }).eq("id", id);
    }

    function renderBuyers(rows) {
      const table = document.getElementById("buyersTable");
      table.innerHTML = "";
      rows.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.name}</td>
          <td>${b.type}</td>
          <td>${b.city||""}</td>
          <td>${b.state||""}</td>
          <td><input type="checkbox" ${b.vip ? "checked" : ""}></td>
          <td>${b.contacted||0}</td>
        `;
        tr.querySelector("input").addEventListener("change", e => {
          toggleVip(b.id, e.target.checked);
        });
        table.appendChild(tr);
      });
    }

    function exportCSV(rows) {
      const headers = ["id","name","type","city","state","vip","contacted"];
      const lines = [headers.join(",")].concat(
        rows.map(r => [
          r.id, `"${r.name.replace(/"/g,'""')}"`, r.type, r.city||"", r.state||"", r.vip?1:0, r.contacted||0
        ].join(","))
      );
      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "buyers_list.csv";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // initial render
    let allBuyers = [];
    async function load() {
      allBuyers = await fetchBuyers();
      renderBuyers(allBuyers);
    }

    document.getElementById("filter").addEventListener("input", e => {
      const q = e.target.value.toLowerCase();
      const filtered = allBuyers.filter(b =>
        b.name.toLowerCase().includes(q) ||
        (b.city||"").toLowerCase().includes(q) ||
        (b.state||"").toLowerCase().includes(q)
      );
      renderBuyers(filtered);
    });

    document.getElementById("exportCsv").addEventListener("click", () => {
      exportCSV(allBuyers);
    });

    load();
  </script>
</body>
</html>
