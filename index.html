<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flip Radar</title>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  :root{
    --brand:#b91c1c;
    --brand-600:#dc2626;
    --text:#0f172a;
    --muted:#64748b;
    --line:#e2e8f0;
    --card:#ffffff;
    --chip:#f1f5f9;
    --btn:#111827;
    --navy:#0c1220;
    --meter-bg:#e5e7eb;
    --meter-bg-dark:#1f2a44;
  }
  .dark{
    --text:#e5e7eb;
    --muted:#94a3b8;
    --line:#141d33;
    --card:#0b0f1a;
    --chip:#0f172a;
    --btn:#e5e7eb;
    background:#0b0f1a;
    color:var(--text);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}

  /* Top bar */
  .topbar{
    position:fixed; inset:0 0 auto 0; height:56px; z-index:40;
    background:#fff; color:#000; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; padding:0 14px;
  }
  .dark .topbar{ background:var(--navy); color:#fff; border-bottom-color:#141d33; }
  .top-left{display:flex; align-items:center; gap:12px}
  .logo{display:flex; align-items:center; gap:8px}
  .logo svg{height:22px; width:22px}
  .logo .word{font-weight:800; letter-spacing:.2px; color:var(--brand)}
  .tabs{display:flex; gap:6px}
  .tab{
    color:#0f172a; background:#fff; border:1px solid var(--line);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    transition:.15s;
  }
  .tab:hover{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .dark .tab{ background:var(--navy); color:#cbd5e1; border-color:#1f2a44 }
  .dark .tab:hover, .dark .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

  .right-actions{display:flex; align-items:center; gap:8px; position:relative}
  .switch{border:1px solid var(--line); border-radius:10px; padding:8px 12px; cursor:pointer; background:#fff}
  .dark .switch{ background:var(--navy); color:#fff; border-color:#1f2a44 }
  .avatar{width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700;background:#ef4444;color:#fff}
  .hamburger{border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff; cursor:pointer}
  .dark .hamburger{ background:var(--navy); color:#fff; border-color:#1f2a44 }

  .menu{position:absolute; right:0; top:46px; background:var(--card); border:1px solid var(--line);
        border-radius:12px; overflow:hidden; min-width:180px; display:none; z-index:50}
  .menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;cursor:pointer}
  .menu button:hover{background:#f3f4f6}
  .dark .menu{border-color:#1f2a44}
  .dark .menu button:hover{background:#0f172a}

  /* Combined search */
  .search-wrap{ position:fixed; z-index:20; left:50%; transform:translateX(-50%); top:72px; width:min(1040px,95vw) }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px;
         box-shadow:0 1px 2px rgba(0,0,0,.06),0 10px 25px rgba(0,0,0,.06); padding:10px }
  .dark .card{ background:var(--navy); border-color:#1f2a44; box-shadow:none }
  .row-flex{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .grow{ flex:1 1 360px; min-width:260px }
  .input{ width:100%; border:1px solid var(--line); background:transparent; color:var(--text);
          border-radius:10px; padding:12px 12px; font-size:14px; outline:0 }
  .dark .input{ border-color:#1f2a44 }
  .sel{ border:1px solid var(--line); background:transparent; color:var(--text);
        border-radius:10px; padding:11px 10px }
  .dark .sel{ border-color:#1f2a44 }
  .label{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:11px 16px;
        border-radius:12px; border:1px solid var(--line); cursor:pointer; white-space:nowrap; font-weight:600 }
  .btn-dark{ background:var(--btn); color:#fff }
  .btn-red{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .btn-red:hover{ background:var(--brand-600); border-color:var(--brand-600) }
  .dark .btn-dark{ background:var(--brand); border-color:var(--brand) } 

  .ac{ position:absolute; left:10px; right:10px; top:calc(100% + 8px); max-height:280px;
       overflow:auto; border-radius:12px; display:none }
  .ac button{ display:block; width:100%; text-align:left; padding:10px 12px; border:0;
              background:var(--card); color:var(--text); cursor:pointer; border-bottom:1px solid var(--line) }
  .ac button:last-child{ border-bottom:0 }
  .ac button:hover{ background:#f3f4f6 }
  .dark .ac button:hover{ background:#0f172a }

  /* Layout */
  .app{ height:100%; display:grid; grid-template-columns:1fr 420px; padding-top:56px }
  @media (max-width: 980px){ .app{ grid-template-columns:1fr } }
  #map{ width:100%; height:100% }

  .sidebar{ border-left:1px solid var(--line); background:var(--card); height:100vh; overflow:auto }
  .dark .sidebar{ border-left-color:#1f2a44 }
  @media (max-width: 980px){ .sidebar{ height:auto } }
  .chips{ display:flex; gap:6px; align-items:center; padding:10px; border-bottom:1px solid var(--line) }
  .chip{ font-size:12px; background:var(--chip); border:1px solid var(--line); padding:4px 8px; border-radius:999px }

  /* New: sidebar toolbar (Sort + results count) */
  .toolbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5; background:var(--card)}
  .dark .toolbar{ border-bottom-color:#1f2a44 }
  .toolbar .count{font-weight:700}

  .tile-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:10px; border-bottom:1px solid var(--line) }
  @media (max-width: 420px){ .tile-grid{ grid-template-columns:1fr } }
  .tile{ padding:10px }
  .muted{ color:var(--muted) }
  .row{ padding:12px; border-bottom:1px solid var(--line) }
  .row .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-weight:600 }
  .badge{ font-size:11px; border:1px solid var(--line); padding:4px 8px; border-radius:999px }
  .badge.blue{ background:#3b82f6; color:#fff; border-color:#3b82f6 }
  .badge.green{ background:#22c55e; color:#fff; border-color:#22c55e }
  .badge.red{ background:#ef4444; color:#fff; border-color:#ef4444 }
  .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px }

  /* Emoji marker styling */
  .pin{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:18px;line-height:1;user-select:none;border:1px solid rgba(255,255,255,0.85);
    box-shadow:0 2px 6px rgba(0,0,0,.25); color:#fff;
  }

  /* Score meter */
  .score { display:flex; align-items:center; gap:8px; margin:8px 0 4px 0; }
  .score .thermo { font-size:16px; line-height:1; }
  .score .meter { flex:1; height:8px; background:var(--meter-bg); border-radius:999px; overflow:hidden; }
  .dark .score .meter { background:var(--meter-bg-dark); }
  .score .fill { height:100%; width:0%; background:#3b82f6; transition:width .25s ease; border-radius:999px; }

  /* Bulk toolbar */
  .bulkbar{ position:sticky; top:0; z-index:4; background:var(--card); border-bottom:1px solid var(--line);
            display:flex; align-items:center; justify-content:space-between; padding:10px 12px }

  /* Settings modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60}
  .modal.show{display:flex}
  .modal .shade{position:absolute; inset:0; background:rgba(0,0,0,.4)}
  .modal .panel{position:relative; background:var(--card); border:1px solid var(--line); border-radius:16px; width:min(720px,95vw); max-height:85vh; overflow:auto; padding:18px}
  .modal h3{margin:0 0 10px 0}
  .modal .row-flex{gap:8px}
  .modal .input{width:100%}
</style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="top-left">
      <a href="#" class="logo" aria-label="Flip Radar">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#b91c1c" stroke-width="2"/>
          <path d="M12 12 L19 7" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
          <circle cx="19" cy="7" r="2" fill="#b91c1c"/>
        </svg>
        <span class="word">Flip&nbsp;Radar</span>
      </a>
      <div class="tabs">
        <button id="tab-buyers" class="tab active">Buyer Search</button>
        <button id="tab-homefull" class="tab">Homefull</button>
        <button id="tab-sniping" class="tab">Wholesaler Sniping</button>
      </div>
    </div>

    <div class="right-actions">
      <button id="darkToggle" class="switch" title="Toggle dark mode">üåô</button>
      <button id="hamburgerBtn" class="hamburger" title="Menu">‚ò∞</button>
      <div id="avatar" class="avatar" title="Profile">FR</div>

      <!-- Profile / Hamburger dropdown -->
      <div id="profileMenu" class="menu">
        <button id="loginBtn">Login</button>
        <button id="settingsBtn">Settings</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- SEARCH + FILTERS -->
  <div class="search-wrap">
    <div class="card" style="position:relative">
      <div class="row-flex">
        <div class="grow">
          <input id="search" class="input" placeholder="Search address"/>
        </div>
        <label class="label">
          Miles
          <select id="miles" class="sel">
            <option>1</option><option selected>2</option><option>3</option><option>5</option><option>10</option><option>15</option>
          </select>
        </label>
        <label class="label">
          Timeline
          <select id="months" class="sel">
            <option value="12" selected>Last 12 mo</option>
            <option value="24">Last 24 mo</option>
          </select>
        </label>
        <button id="searchBtn" class="btn btn-red">Search</button>
      </div>
      <div id="ac" class="card ac"></div>
    </div>
  </div>

  <div class="app" id="appRoot">
    <div id="map"></div>

    <aside class="sidebar" id="sidebar">
      <div class="chips">
        <span class="chip" id="modeChip">Buyer Search</span>
        <span class="chip" id="chipMiles">2 mi</span>
        <span class="chip" id="chipMonths">12 mo</span>
      </div>

      <!-- NEW: Toolbar with Sort dropdown (blue-circled control) + results count -->
      <div class="toolbar">
        <label class="label" style="margin:0">
          Sort by
          <select id="sortBy" class="sel">
            <option value="score">Buyer Score (hot ‚Üí cold)</option>
            <option value="distance">Distance (near ‚Üí far)</option>
            <option value="contacted">Most Contacted</option>
            <option value="recent">Most Recent Purchase</option>
            <option value="deals">Most Deals</option>
          </select>
        </label>
        <div class="count">Results: <span id="resultCount">0</span></div>
      </div>

      <div class="tile-grid" id="metricTiles">
        <div class="card tile">
          <div style="font-weight:600">üî® Flippers</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgFlip" style="font-weight:700;font-size:18px;">$‚Äî</div>
          <div class="muted" style="font-size:12px;">activity last <span id="tileMonthsA">12</span> mo</div>
        </div>
        <div class="card tile">
          <div style="font-weight:600">üè† Landlords</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgLand" style="font-weight:700;font-size:18px;">$‚Äî</div>
          <div class="muted" style="font-size:12px;">activity last <span id="tileMonthsB">12</span> mo</div>
        </div>
      </div>

      <!-- bulk toolbar -->
      <div class="bulkbar">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="selectAll"/>
          <span class="muted">Select all</span>
        </label>
        <div style="display:flex;gap:8px">
          <button id="bulkSkip" class="btn btn-red" disabled>Skip Trace Selected</button>
        </div>
      </div>

      <div id="results"></div>
    </aside>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="shade"></div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3>Settings</h3>
        <button id="closeSettings" class="btn">‚úï</button>
      </div>
      <div class="muted" style="margin-bottom:12px">Configure your integrations. Values are saved in your browser.</div>

      <div class="row-flex">
        <label class="label grow">BatchData Webhook (bulk skiptrace)
          <input id="set-skiptrace" class="input" placeholder="https://your-worker/skiptrace"/>
        </label>
      </div>
      <div class="row-flex">
        <label class="label grow">Email Webhook (SendGrid)
          <input id="set-email" class="input" placeholder="https://your-worker/send-email"/>
        </label>
      </div>
      <div class="row-flex">
        <label class="label grow">SMS Webhook
          <input id="set-sms" class="input" placeholder="https://your-worker/sms"/>
        </label>
      </div>
      <div class="row-flex">
        <label class="label grow">RVM Webhook
          <input id="set-rvm" class="input" placeholder="https://your-worker/rvm"/>
        </label>
      </div>
      <div class="row-flex">
        <label class="label grow">CRM Webhook (Export to CRM)
          <input id="set-crm" class="input" placeholder="https://your-worker/crm"/>
        </label>
      </div>
      <div class="row-flex">
        <label class="label grow">Apollo Proxy URL (optional)
          <input id="set-apollo" class="input" placeholder="https://your-worker/apollo"/>
        </label>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="saveSettings" class="btn btn-red">Save Settings</button>
        <span id="saveNote" class="muted" role="status"></span>
      </div>
    </div>
  </div>

  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script>
    /* ===================== CONFIG ===================== */
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiaG9tZXByb3MyMDI1IiwiYSI6ImNtZjlyOWdlejAwa2QycnE3cnNibnNvZjIifQ.gGgpxSOWpu2dTZ2N-o8pEQ';

    /* ===================== DEMO DATA ===================== */
    const buyers = [
      { id:'b1', name:'Evergreen Residential LLC', buyer_type:'Flipper', contacts:[{phone:'210-555-0187'}]},
      { id:'b2', name:'Alamo Rentals Group',      buyer_type:'Landlord', contacts:[{phone:'210-555-0142'}]},
      { id:'b3', name:'River City Capital',       buyer_type:'Cash',     contacts:[{phone:'210-555-0199'}]},
      { id:'b4', name:'Hill Country Flips',       buyer_type:'Flipper',  contacts:[{email:'offers@hillcountryflips.com'}]},
    ];
    const properties = [
      { id:'p1', addr1:'112 Blanco Rd', city:'San Antonio', state:'TX', zip:'78212', lat:29.462, lon:-98.501 },
      { id:'p2', addr1:'2744 Briarhurst Dr #38', city:'Houston', state:'TX', zip:'77057', lat:29.741, lon:-95.483 },
      { id:'p3', addr1:'501 Woodlawn Ave', city:'San Antonio', state:'TX', zip:'78201', lat:29.458, lon:-98.514 },
      { id:'p4', addr1:'2803 W Martin St', city:'San Antonio', state:'TX', zip:'78207', lat:29.422, lon:-98.514 },
      { id:'p5', addr1:'133 King William St', city:'San Antonio', state:'TX', zip:'78204', lat:29.410, lon:-98.495 },
      { id:'p6', addr1:'845 S Presa St', city:'San Antonio', state:'TX', zip:'78210', lat:29.411, lon:-98.487 },
    ];
    const events = [
      { id:'e1', buyer_id:'b1', property_id:'p1', event_type:'purchase', event_date:'2025-07-21', price:275000, source:'county' },
      { id:'e2', buyer_id:'b1', property_id:'p3', event_type:'purchase', event_date:'2025-05-10', price:245000, source:'county' },
      { id:'e3', buyer_id:'b1', property_id:'p5', event_type:'purchase', event_date:'2024-12-19', price:310000, source:'mls' },
      { id:'e4', buyer_id:'b2', property_id:'p4', event_type:'purchase', event_date:'2025-03-02', price:190000, source:'county' },
      { id:'e5', buyer_id:'b2', property_id:'p6', event_type:'purchase', event_date:'2024-10-11', price:215000, source:'county' },
      { id:'e6', buyer_id:'b3', property_id:'p1', event_type:'purchase', event_date:'2024-09-20', price:260000, source:'county' },
      { id:'e7', buyer_id:'b4', property_id:'p6', event_type:'purchase', event_date:'2025-08-05', price:330000, source:'mls' },
    ];

    /* ===================== STATE ===================== */
    const INITIAL={lat:29.4241, lon:-98.4936};
    let mode='buyers', center={...INITIAL}, miles=2, months=12;
    let sortMode='score';
    let isAuthed = JSON.parse(localStorage.getItem('fr_authed') || 'false');
    const selected = new Set();

    /* ===================== HELPERS ===================== */
    function monthsAgo(n){ const d=new Date(); d.setMonth(d.getMonth()-n); return d; }
    function distanceMiles(a,b){
      const R=3958.8,toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function circlePolygon(lon,lat,mi,pts=64){
      const coords=[], R=3958.8, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
      const latR=toRad(lat), lonR=toRad(lon), ang=mi/R;
      for(let i=0;i<=pts;i++){
        const br=(i/pts)*2*Math.PI;
        const lat2=Math.asin(Math.sin(latR)*Math.cos(ang)+Math.cos(latR)*Math.sin(ang)*Math.cos(br));
        const lon2=lonR+Math.atan2(Math.sin(br)*Math.sin(ang)*Math.cos(latR), Math.cos(ang)-Math.sin(latR)*Math.sin(lat2));
        coords.push([toDeg(lon2), toDeg(lat2)]);
      }
      return { type:'Feature', geometry:{type:'Polygon',coordinates:[coords]}, properties:{} };
    }

    function totalDealsLastMonths(buyerId, mo){
      const since=monthsAgo(mo);
      return events.filter(e=>e.buyer_id===buyerId && e.event_type==='purchase' && new Date(e.event_date)>=since).length;
    }

    function computeResults(cen,mi,mo){
      const since=monthsAgo(mo);
      const filtered=events.filter(e=>{
        const p=properties.find(pp=>pp.id===e.property_id); if(!p) return false;
        return e.event_type==='purchase' && new Date(e.event_date)>=since &&
               distanceMiles(cen,{lat:p.lat,lon:p.lon})<=mi;
      });

      const by={};
      filtered.forEach(ev=>{
        const b=buyers.find(bb=>bb.id===ev.buyer_id); if(!b) return;
        const prop=properties.find(pp=>pp.id===ev.property_id); if(!prop) return;
        const dist=distanceMiles(cen,{lat:prop.lat,lon:prop.lon});
        if(!by[b.id]){
          by[b.id] = {
            buyer:b, deals:[], last:new Date(0), lastCoord:null, minDist:Infinity
          };
        }
        by[b.id].deals.push(ev);
        if(dist<by[b.id].minDist) by[b.id].minDist = dist;
        const d=new Date(ev.event_date);
        if(d>by[b.id].last){
          by[b.id].last=d;
          by[b.id].lastCoord=[prop.lon,prop.lat];
        }
      });

      const out = Object.values(by).map(v=>{
        const prices=v.deals.map(d=>d.price).sort((a,b)=>a-b);
        const mid=Math.floor(prices.length/2);
        const median=prices.length%2?prices[mid]:(prices[mid-1]+prices[mid])/2;
        const portfolio24 = totalDealsLastMonths(v.buyer.id, 24);
        return {
          id:v.buyer.id,
          name:v.buyer.name,
          buyer_type:v.buyer.buyer_type,
          contacts:v.buyer.contacts,
          deals:v.deals.length,
          last:v.last,
          median,
          coord:v.lastCoord,
          dist:v.minDist,
          portfolio24
        };
      });

      // Base sort (will be refined in refreshAll)
      out.sort((a,b)=>b.deals-a.deals || a.dist-b.dist || b.last-a.last);
      return out;
    }

    // Buyer Score
    function buyerScore(r){
      const prox = Math.max(0, Math.min(100, Math.round((1 - (r.dist / Math.max(0.1, miles))) * 100)));
      const activity = Math.max(0, Math.min(100, r.deals * 20));
      const portfolio = Math.max(0, Math.min(100, r.portfolio24 * 10));
      const days = Math.max(1, (Date.now() - r.last.getTime())/(1000*60*60*24));
      const recency = Math.max(0, 100 - Math.min(100, Math.round(days / 3)));
      const score = Math.round(0.25*prox + 0.25*activity + 0.15*portfolio + 0.35*recency);
      return Math.max(0, Math.min(100, score));
    }
    function scoreColor(p){
      if (p < 40) return '#3b82f6';
      if (p < 70) return '#f59e0b';
      if (p < 90) return '#ef4444cc';
      return '#ef4444';
    }

    /* ===================== MAP ===================== */
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const mapStyleLight = 'mapbox://styles/mapbox/light-v11';
    const mapStyleDark  = 'mapbox://styles/mapbox/dark-v11';

    let map = new mapboxgl.Map({
      container:'map',
      style: mapStyleLight,
      center:[INITIAL.lon,INITIAL.lat],
      zoom:11
    });
    map.addControl(new mapboxgl.NavigationControl());

    function addRadiusSources(){
      if(map.getSource('radius')) return;
      map.addSource('radius',{ type:'geojson', data:circlePolygon(center.lon,center.lat,miles) });
      map.addLayer({ id:'radius-fill', type:'fill', source:'radius', paint:{ 'fill-color':'#ef4444','fill-opacity':0.08 }});
      map.addLayer({ id:'radius-line', type:'line', source:'radius', paint:{ 'line-color':'#ef4444','line-width':2 }});
    }
    map.on('load',()=>{ addRadiusSources(); refreshAll(true); });
    map.on('click', e=>{ center={lat:e.lngLat.lat, lon:e.lngLat.lng}; refreshAll(true); });

    function switchStyle(){
      const style = document.body.classList.contains('dark') ? mapStyleDark : mapStyleLight;
      map.setStyle(style);
      map.once('style.load',()=>{ addRadiusSources(); refreshAll(false); });
    }

    // DOM markers
    const markerById = new Map();
    function clearMarkers(){
      for(const {marker,popup} of markerById.values()){ popup.remove(); marker.remove(); }
      markerById.clear();
    }
    const emojiFor = t => t==='Flipper'?'üõ†Ô∏è':(t==='Landlord'?'üè†':'üíµ');
    const colorFor = t => t==='Flipper'?'#3b82f6':(t==='Landlord'?'#22c55e':'#ef4444');
    const labelFor = t => t==='Flipper'?'Flipper':(t==='Landlord'?'Landlord':'Cash');
    function buildMarkers(results){
      clearMarkers();
      results.forEach(r=>{
        const coords = r.coord || [center.lon,center.lat];
        const el = document.createElement('div');
        el.className = 'pin';
        el.textContent = emojiFor(r.buyer_type);
        el.style.backgroundColor = colorFor(r.buyer_type);
        const popup = new mapboxgl.Popup({ closeButton:false, offset: 12 })
          .setHTML(`<div style="font-weight:700">${r.name}</div>
                    <div style="font-size:12px;opacity:.8">${labelFor(r.buyer_type)}</div>
                    <div style="font-size:12px;opacity:.8">~${r.dist.toFixed(2)} mi</div>`);
        const marker = new mapboxgl.Marker({ element: el, anchor:'center' }).setLngLat(coords).setPopup(popup).addTo(map);
        el.addEventListener('mouseenter', ()=> marker.togglePopup());
        el.addEventListener('mouseleave', ()=> marker.togglePopup());
        markerById.set(r.id, { marker, popup, coords });
      });
    }

    /* ===================== UI WIRING ===================== */
    const tBuy=document.getElementById('tab-buyers');
    const tHome=document.getElementById('tab-homefull');
    const tSni=document.getElementById('tab-sniping');
    function setActive(){
      tBuy.classList.toggle('active',mode==='buyers');
      tHome.classList.toggle('active',mode==='homefull');
      tSni.classList.toggle('active',mode==='sniping');
      document.getElementById('modeChip').textContent =
        mode==='buyers'?'Buyer Search':(mode==='homefull'?'Homefull':'Wholesaler Sniping');
      document.getElementById('metricTiles').style.display = (mode==='buyers')?'grid':'none';
    }
    tBuy.onclick=()=>{mode='buyers'; setActive(); refreshAll(false);}
    tHome.onclick=()=>{mode='homefull'; setActive(); refreshAll(false);}
    tSni.onclick=()=>{mode='sniping'; setActive(); refreshAll(false);}

    document.getElementById('darkToggle').onclick = ()=>{
      document.body.classList.toggle('dark');
      document.getElementById('searchBtn').className = 'btn btn-red';
      switchStyle();
    };

    document.getElementById('searchBtn').className = 'btn btn-red';

    document.getElementById('miles').onchange = e=>{ miles=parseFloat(e.target.value); refreshAll(true); };
    document.getElementById('months').onchange = e=>{ months=parseInt(e.target.value,10); refreshAll(false); };
    document.getElementById('sortBy').onchange = e=>{ sortMode=e.target.value; refreshAll(false); };

    // search & autocomplete
    const ac=document.getElementById('ac');
    const search=document.getElementById('search');
    document.getElementById('searchBtn').onclick = ()=> doSearch(search.value);
    search.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(search.value); });
    let acTimer=null;
    search.addEventListener('input', ()=>{
      const q=search.value.trim();
      if(!q || q.length<3){ ac.style.display='none'; ac.innerHTML=''; return; }
      clearTimeout(acTimer);
      acTimer=setTimeout(()=>{
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&autocomplete=true&limit=5&country=us`)
          .then(r=>r.json()).then(d=>{
            const feats=d.features||[];
            if(!feats.length){ ac.style.display='none'; ac.innerHTML=''; return; }
            ac.innerHTML = feats.map((f,i)=>`<button data-i="${i}">${f.place_name}</button>`).join('');
            ac.style.display='block';
            Array.from(ac.querySelectorAll('button')).forEach((b,idx)=>{
              b.onclick = ()=> doSearch(feats[idx].place_name);
            });
          }).catch(()=>{});
      }, 200);
    });
    function doSearch(q){
      const s=q.trim(); if(!s) return;
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(s)}.json?access_token=${MAPBOX_TOKEN}&limit=1&country=us`)
        .then(r=>r.json()).then(d=>{
          const f=d.features?.[0]; if(!f) return;
          const [lon,lat]=f.center; center={lat,lon};
          search.value=f.place_name; ac.style.display='none'; ac.innerHTML='';
          refreshAll(true);
        }).catch(()=>{});
    }

    /* ===================== RENDER ===================== */
    const resultsDiv = document.getElementById('results');
    const selectAllEl = document.getElementById('selectAll');
    const bulkBtn = document.getElementById('bulkSkip');
    const resultCountEl = document.getElementById('resultCount');

    function updateBulkUI(){
      bulkBtn.disabled = selected.size===0;
      const total = resultsDiv.querySelectorAll('.row[data-id]').length||0;
      selectAllEl.indeterminate = selected.size>0 && selected.size < total;
      selectAllEl.checked = total>0 && selected.size === total;
    }

    selectAllEl.addEventListener('change', ()=>{
      const check = selectAllEl.checked;
      selected.clear();
      resultsDiv.querySelectorAll('input[type="checkbox"][data-id]').forEach(cb=>{
        cb.checked = check;
        if(check) selected.add(cb.dataset.id);
      });
      updateBulkUI();
    });

    bulkBtn.addEventListener('click', ()=>{
      alert(`Bulk skiptrace for ${selected.size} selected buyers:\n\n` + [...selected].join('\n'));
    });

    function resultRowHTML(r){
      const color = r.buyer_type==='Flipper'?'blue':(r.buyer_type==='Landlord'?'green':'red');
      const s = buyerScore(r);
      return `
        <div class="top" style="gap:10px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" data-id="${r.id}"/>
            <div>${r.name}</div>
          </label>
          <span class="badge ${color}">${r.buyer_type}</span>
        </div>

        <div class="score" title="Buyer Score">
          <span class="thermo">${(s<40)?'ü•∂':(s<70?'üå°Ô∏è':'ü•µ')}</span>
          <div class="meter"><div class="fill" style="width:${s}%;background:${scoreColor(s)}"></div></div>
          <span style="min-width:40px;text-align:right;font-weight:700">${s}%</span>
        </div>

        <div class="muted" style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge" style="background:#eef2ff;border-color:#eef2ff;color:#3730a3">Dist ~ ${r.dist.toFixed(2)} mi</span>
          <span class="badge" style="background:#fef3c7;border-color:#fef3c7;color:#92400e">True count: ${r.deals}</span>
          <span class="badge" style="background:#d1fae5;border-color:#d1fae5;color:#065f46">Portfolio 24m: ${r.portfolio24}</span>
          <span class="badge" style="background:#fee2e2;border-color:#fee2e2;color:#7f1d1d">Last: ${r.last.toLocaleDateString()}</span>
        </div>

        <div class="muted" style="margin-top:6px;">Median price: $${r.median.toLocaleString()}</div>
        <div class="actions">
          <button class="btn">Skip Trace</button>
          <button class="btn btn-red">+ Add to Buyers List</button>
        </div>
      `;
    }

    function sortResults(res){
      switch(sortMode){
        case 'distance':
          res.sort((a,b)=>a.dist-b.dist || b.deals-a.deals || b.last-a.last); break;
        case 'recent':
          res.sort((a,b)=>b.last-a.last || a.dist-b.dist); break;
        case 'deals':
          res.sort((a,b)=>b.deals-a.deals || a.dist-b.dist || b.last-a.last); break;
        case 'contacted':
          // proxy using portfolio24 as "contact frequency"
          res.sort((a,b)=>b.portfolio24-a.portfolio24 || b.deals-a.deals || a.dist-b.dist); break;
        case 'score':
        default:
          res.sort((a,b)=>buyerScore(b)-buyerScore(a) || a.dist-b.dist); break;
      }
      return res;
    }

    function refreshAll(fly){
      document.getElementById('chipMiles').textContent=`${miles} mi`;
      document.getElementById('chipMonths').textContent=`${months} mo`;
      document.getElementById('tileMonthsA').textContent=months;
      document.getElementById('tileMonthsB').textContent=months;

      let res=computeResults(center,miles,months);
      res = sortResults(res);

      // metrics
      const avg=a=>Math.round((a.reduce((x,y)=>x+y,0))/(a.length||1));
      const flips=res.filter(r=>r.buyer_type==='Flipper').map(r=>r.median);
      const lands=res.filter(r=>r.buyer_type==='Landlord').map(r=>r.median);
      document.getElementById('avgFlip').textContent=`$${(flips.length?avg(flips):0).toLocaleString()}`;
      document.getElementById('avgLand').textContent=`$${(lands.length?avg(lands):0).toLocaleString()}`;

      // results count (top-right of toolbar)
      resultCountEl.textContent = res.length;

      // sidebar list
      selected.clear();
      resultsDiv.innerHTML='';
      if(mode==='buyers'){
        if(!res.length){
          resultsDiv.innerHTML=`<div class="row muted">No active buyers found within ${miles} mi. Try widening the radius or time window.</div>`;
        }else{
          res.forEach(r=>{
            const row=document.createElement('div'); row.className='row'; row.dataset.id=r.id;
            row.innerHTML = resultRowHTML(r);

            row.addEventListener('mouseenter', ()=>{
              const m = markerById.get(r.id); if(!m) return;
              m.marker.togglePopup(); map.easeTo({ center:m.coords, duration:600, zoom:Math.max(map.getZoom(),11) });
            });
            row.addEventListener('mouseleave', ()=>{
              const m = markerById.get(r.id); if(!m) return; m.marker.togglePopup();
            });
            row.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
              const id = e.target.dataset.id;
              if(e.target.checked) selected.add(id); else selected.delete(id);
              updateBulkUI();
            });

            resultsDiv.appendChild(row);
          });
        }
      }else if(mode==='homefull'){
        resultsDiv.innerHTML=`
          <div class="row"><b>Homefull</b><div class="muted">AI-OCR on active & sold listings; agent leaderboard.</div></div>
          <div class="row">
            <div class="top"><div>506 Washington Blvd</div><span class="badge">Flip-Like 0.81</span></div>
            <div class="muted">Staged ‚Ä¢ LVP ‚Ä¢ Subway tile ‚Ä¢ Matte black</div>
            <div class="muted" style="margin-top:6px;">Agent: Leslie Elrod (432) 517-0038</div>
            <div class="actions"><button class="btn">Call Agent</button><button class="btn btn-red">Skiptrace Owner</button></div>
          </div>`;
      }else{
        resultsDiv.innerHTML=`
          <div class="row"><b>Wholesaler Sniping</b><div class="muted">Grantor ‚Üí Grantee repeat pairs (last ${months} mo).</div></div>
          <div class="row">
            <div class="top"><div>ABC Investments LLC ‚Üí Evergreen Homes LLC</div><span class="badge">6 in 12 mo</span></div>
            <div class="muted">last_deal: 2025-06-11</div>
            <div class="actions"><button class="btn">Skiptrace Buyer</button><button class="btn btn-red">+ Add to Buyers List</button></div>
          </div>`;
      }

      updateBulkUI();

      buildMarkers(res);
      const radiusSrc=map.getSource('radius'); if(radiusSrc) radiusSrc.setData(circlePolygon(center.lon,center.lat,miles));
      if(fly) map.flyTo({center:[center.lon,center.lat], zoom:Math.max(map.getZoom(),11), essential:true});
    }

    // tabs + initial
    setActive();

    /* ===================== PROFILE / MENU / SETTINGS ===================== */
    const avatarEl = document.getElementById('avatar');
    const menuEl = document.getElementById('profileMenu');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    function toggleMenu(){ menuEl.style.display = (menuEl.style.display==='block')?'none':'block'; }
    avatarEl.addEventListener('click', toggleMenu);
    hamburgerBtn.addEventListener('click', toggleMenu);
    document.addEventListener('click',(e)=>{
      if(!menuEl.contains(e.target) && !avatarEl.contains(e.target) && !hamburgerBtn.contains(e.target)){
        menuEl.style.display='none';
      }
    });

    const loginBtn=document.getElementById('loginBtn');
    const logoutBtn=document.getElementById('logoutBtn');
    function renderAuth(){
      loginBtn.style.display = isAuthed?'none':'block';
      logoutBtn.style.display = isAuthed?'block':'none';
      avatarEl.textContent = isAuthed ? 'FR' : 'GU';
      localStorage.setItem('fr_authed', JSON.stringify(isAuthed));
    }
    loginBtn.onclick=()=>{ isAuthed=true; renderAuth(); menuEl.style.display='none'; };
    logoutBtn.onclick=()=>{ isAuthed=false; renderAuth(); menuEl.style.display='none'; };
    renderAuth();

    // Settings modal
    const settingsBtn=document.getElementById('settingsBtn');
    const settingsModal=document.getElementById('settingsModal');
    const closeSettings=document.getElementById('closeSettings');
    const saveSettings=document.getElementById('saveSettings');
    const saveNote=document.getElementById('saveNote');

    const fields = {
      skiptrace: document.getElementById('set-skiptrace'),
      email: document.getElementById('set-email'),
      sms: document.getElementById('set-sms'),
      rvm: document.getElementById('set-rvm'),
      crm: document.getElementById('set-crm'),
      apollo: document.getElementById('set-apollo'),
    };
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem('fr_settings') || '{}');
      Object.keys(fields).forEach(k=> fields[k].value = s[k] || '');
    }
    function openSettings(){ loadSettings(); settingsModal.classList.add('show'); }
    function closeSettingsFn(){ settingsModal.classList.remove('show'); }
    settingsBtn.onclick=()=>{ openSettings(); menuEl.style.display='none'; };
    closeSettings.onclick=closeSettingsFn;
    settingsModal.querySelector('.shade').onclick=closeSettingsFn;

    saveSettings.onclick=()=>{
      const data = Object.fromEntries(Object.entries(fields).map(([k,el])=>[k, el.value.trim()]));
      localStorage.setItem('fr_settings', JSON.stringify(data));
      saveNote.textContent='Saved!';
      setTimeout(()=> saveNote.textContent='', 1200);
    };
  </script>
</body>
</html>
