<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flip Radar</title>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  :root{
    --brand:#b91c1c;         /* darker red */
    --brand-600:#dc2626;     /* hover red */
    --text:#0f172a;          /* slate-900 */
    --muted:#64748b;         /* slate-500 */
    --line:#e2e8f0;          /* slate-200 */
    --card:#ffffff;
    --chip:#f1f5f9;          /* slate-100 */
    --btn:#111827;           /* near black */
    --navy:#0c1220;          /* dark header/search */
    --good:#22c55e;          /* green */
    --blue:#3b82f6;          /* blue */
    --warn:#f59e0b;          /* amber */
  }
  .dark{
    --text:#e5e7eb;
    --muted:#94a3b8;
    --line:#141d33;
    --card:#0b0f1a;
    --chip:#0f172a;
    --btn:#e5e7eb;
    background:#0b0f1a;
    color:var(--text);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}

  /* Top bar */
  .topbar{
    position:fixed; inset:0 0 auto 0; height:56px; z-index:30;
    background:#fff; color:#000; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; padding:0 14px;
  }
  .dark .topbar{ background:var(--navy); color:#fff; border-bottom-color:#141d33; }
  .top-left{display:flex; align-items:center; gap:12px}
  .logo{display:flex; align-items:center; gap:8px}
  .logo svg{height:22px; width:22px}
  .logo .word{font-weight:800; letter-spacing:.2px; color:var(--brand)}
  .tabs{display:flex; gap:6px}
  .tab{
    color:#0f172a; background:#fff; border:1px solid var(--line);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    transition:.15s;
  }
  .tab:hover{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .dark .tab{ background:var(--navy); color:#cbd5e1; border-color:#1f2a44 }
  .dark .tab:hover, .dark .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

  .right-actions{display:flex; align-items:center; gap:8px; position:relative}
  .switch{border:1px solid var(--line); border-radius:10px; padding:8px 12px; cursor:pointer; background:#fff}
  .dark .switch{ background:var(--navy); color:#fff; border-color:#1f2a44 }
  .profile{border:1px solid var(--line); border-radius:999px; padding:8px 10px; cursor:pointer; background:#fff}
  .dark .profile{ background:var(--navy); color:#fff; border-color:#1f2a44 }
  .menu{position:absolute; top:44px; right:0; background:var(--card); border:1px solid var(--line); border-radius:12px; min-width:220px; display:none; z-index:50}
  .menu button{display:block; width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:var(--text); cursor:pointer}
  .menu button:hover{background:rgba(0,0,0,.04)}
  .dark .menu button:hover{background:#0f172a}

  /* Combined search */
  .search-wrap{ position:fixed; z-index:20; left:50%; transform:translateX(-50%); top:72px; width:min(1040px,95vw) }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px;
         box-shadow:0 1px 2px rgba(0,0,0,.06),0 10px 25px rgba(0,0,0,.06); padding:10px }
  .dark .card{ background:var(--navy); border-color:#1f2a44; box-shadow:none }
  .row-flex{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .grow{ flex:1 1 360px }
  .input{ width:100%; border:1px solid var(--line); background:transparent; color:var(--text);
          border-radius:10px; padding:10px 12px; font-size:14px; outline:0 }
  .dark .input{ border-color:#1f2a44 }
  .sel{ border:1px solid var(--line); background:transparent; color:var(--text);
        border-radius:10px; padding:9px 10px }
  .dark .sel{ border-color:#1f2a44 }
  .label{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px;
        border-radius:12px; border:1px solid var(--line); cursor:pointer; white-space:nowrap }
  .btn-dark{ background:var(--brand); color:#fff; border-color:var(--brand) }  /* red in light */
  .btn-ghost{ background:transparent; color:var(--text) }
  .btn-red{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .btn-red:hover{ background:var(--brand-600); border-color:var(--brand-600) }
  .dark .btn-dark{ background:var(--brand); border-color:var(--brand) }

  .ac{ position:absolute; left:10px; right:10px; top:calc(100% + 8px); max-height:280px;
       overflow:auto; border-radius:12px; display:none }
  .ac button{ display:block; width:100%; text-align:left; padding:10px 12px; border:0;
              background:var(--card); color:var(--text); cursor:pointer; border-bottom:1px solid var(--line) }
  .ac button:last-child{ border-bottom:0 }
  .ac button:hover{ background:#f3f4f6 }
  .dark .ac button:hover{ background:#0f172a }

  /* Layout */
  .app{ height:100%; display:grid; grid-template-columns:1fr 420px; padding-top:56px }
  @media (max-width: 980px){ .app{ grid-template-columns:1fr } }
  #map{ width:100%; height:100% }

  .sidebar{ border-left:1px solid var(--line); background:var(--card); height:100vh; overflow:auto }
  .dark .sidebar{ border-left-color:#1f2a44 }
  @media (max-width: 980px){ .sidebar{ height:auto } }
  .chips{ display:flex; gap:6px; align-items:center; padding:10px; border-bottom:1px solid var(--line) }
  .chip{ font-size:12px; background:var(--chip); border:1px solid var(--line); padding:4px 8px; border-radius:999px }
  .tile-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:10px; border-bottom:1px solid var(--line) }
  @media (max-width: 420px){ .tile-grid{ grid-template-columns:1fr } }
  .tile{ padding:10px }
  .muted{ color:var(--muted) }
  .row{ padding:12px; border-bottom:1px solid var(--line) }
  .row .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-weight:600 }
  .badge{ font-size:11px; border:1px solid var(--line); padding:4px 8px; border-radius:999px }
  .badge.blue{ background:#3b82f6; color:#fff; border-color:#3b82f6 }
  .badge.green{ background:#22c55e; color:#fff; border-color:#22c55e }
  .badge.red{ background:#ef4444; color:#fff; border-color:#ef4444 }
  .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px }

  /* Emoji marker styling (colored background now controlled per-type) */
  .pin{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:18px;line-height:1;user-select:none;box-shadow:0 2px 6px rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,0.8); color:#fff;
  }

  /* Buyers List (sheet style) */
  .tools{ display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--line); align-items:center; justify-content:space-between }
  .filters{ display:flex; gap:8px; align-items:center }
  .table{ width:100%; border-collapse:separate; border-spacing:0 }
  .table th, .table td{ padding:8px 10px; border-bottom:1px solid var(--line); text-align:left }
  .table th{ background:var(--chip); position:sticky; top:0; z-index:1 }
  .star{ cursor:pointer; font-size:16px }
  .star.vip{ color:var(--brand) }
  .small{ font-size:12px; color:var(--muted) }

  /* Temperature bar */
  .therm-wrap{display:inline-flex; align-items:center; gap:6px}
  .therm-bar{width:90px; height:8px; border-radius:999px; background:#e5e7eb; overflow:hidden; border:1px solid #e5e7eb}
  .dark .therm-bar{ background:#0f172a; border-color:#1f2a44 }
  .therm-fill{height:100%; width:0%}

</style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="top-left">
      <a href="#" class="logo" aria-label="Flip Radar">
        <!-- red radar SVG -->
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="#b91c1c" stroke-width="2"/>
          <path d="M12 12 L19 7" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/>
          <circle cx="19" cy="7" r="2" fill="#b91c1c"/>
        </svg>
        <span class="word">Flip&nbsp;Radar</span>
      </a>
      <div class="tabs">
        <button id="tab-buyers" class="tab active">Buyer Search</button>
        <button id="tab-homefull" class="tab">Homefull</button>
        <button id="tab-sniping" class="tab">Wholesaler Sniping</button>
        <button id="tab-list" class="tab">Buyers List</button>
        <button id="tab-settings" class="tab">Settings</button>
      </div>
    </div>
    <div class="right-actions">
      <button id="darkToggle" class="switch" title="Toggle dark mode">üåô</button>
      <button id="profileBtn" class="profile" title="Profile / Logout">üë§</button>
      <div id="profileMenu" class="menu">
        <button id="loginBtn">Login</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <!-- SEARCH + FILTERS -->
  <div class="search-wrap" id="searchWrap">
    <div class="card" style="position:relative">
      <div class="row-flex">
        <div class="grow">
          <input id="search" class="input" placeholder="Search address"/>
        </div>
        <label class="label">
          Miles
          <select id="miles" class="sel">
            <option>1</option><option selected>2</option><option>3</option><option>5</option><option>10</option><option>15</option>
          </select>
        </label>
        <label class="label">
          Timeline
          <select id="months" class="sel">
            <option value="12" selected>Last 12 mo</option>
            <option value="24">Last 24 mo</option>
          </select>
        </label>
        <button id="searchBtn" class="btn btn-dark">Search</button>
      </div>
      <div id="ac" class="card ac"></div>
    </div>
  </div>

  <div class="app">
    <div id="map"></div>

    <aside class="sidebar" id="sidebar">
      <!-- Shared chips (hidden on Buyers List / Settings) -->
      <div class="chips" id="chips">
        <span class="chip" id="modeChip">Buyer Search</span>
        <span class="chip" id="chipMiles">2 mi</span>
        <span class="chip" id="chipMonths">12 mo</span>
      </div>

      <!-- Metric tiles (only for Buyer Search) -->
      <div class="tile-grid" id="metricTiles">
        <div class="card tile">
          <div style="font-weight:600">üî® Flippers</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgFlip" style="font-weight:700;font-size:18px;">$‚Äî</div>
          <div class="muted small">activity last <span id="tileMonthsA">12</span> mo</div>
        </div>
        <div class="card tile">
          <div style="font-weight:600">üè† Landlords</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgLand" style="font-weight:700;font-size:18px;">$‚Äî</div>
          <div class="muted small">activity last <span id="tileMonthsB">12</span> mo</div>
        </div>
      </div>

      <!-- Buyer Search content -->
      <div id="searchContent">
        <!-- bulk toolbar -->
        <div class="tools">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="selectAll"/>
            <span class="muted">Select all</span>
          </label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="sortBy" class="sel">
              <option value="temperature">Sort by Temperature (desc)</option>
              <option value="distance">Sort by Distance (asc)</option>
              <option value="contacted">Sort by Most Contacted</option>
              <option value="last">Sort by Soonest Purchase Date</option>
              <option value="deals">Sort by Deals (desc)</option>
            </select>
            <button id="bulkSkip" class="btn btn-red" disabled>Skip Trace Selected</button>
          </div>
        </div>
        <div id="results"></div>
      </div>

      <!-- Buyers List content -->
      <div id="listContent" style="display:none">
        <div class="tools">
          <div class="filters">
            <input id="locFilter" class="input" style="width:260px" placeholder="Filter by location (city, state, zip)"/>
            <label style="display:flex;align-items:center;gap:6px">
              <input id="vipOnly" type="checkbox"/> <span class="muted">VIP only</span>
            </label>
          </div>
          <div style="display:flex;gap:8px">
            <button id="exportCsv" class="btn btn-ghost">Export CSV</button>
            <button id="exportCrm" class="btn btn-red">Export to CRM</button>
          </div>
        </div>
        <div style="overflow:auto; max-height:calc(100vh - 220px)">
          <table class="table" id="listTable">
            <thead>
              <tr>
                <th style="width:36px"><input type="checkbox" id="listSelectAll"/></th>
                <th>Buyer</th>
                <th>Type</th>
                <th>Deals</th>
                <th>Last</th>
                <th>Median</th>
                <th>Location</th>
                <th>VIP</th>
                <th>Contacted</th>
              </tr>
            </thead>
            <tbody id="listTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings content -->
      <div id="settingsContent" style="display:none">
        <div class="row" style="display:grid; gap:12px">
          <div style="font-weight:700">Integrations</div>
          <label>Webhook URL (Export to CRM)
            <input id="webhookUrl" class="input" placeholder="https://your-crm-webhook/ingest"/>
          </label>
          <label>API Key (optional, sent as header <code>X-API-Key</code>)
            <input id="apiKey" class="input" placeholder="(optional)"/>
          </label>
          <div style="display:flex; gap:8px">
            <button id="saveSettings" class="btn btn-red">Save</button>
            <button id="testWebhook" class="btn btn-ghost">Send Test</button>
          </div>
          <div class="small muted">We only send selected buyers as JSON via POST to your webhook.</div>
        </div>
      </div>
    </aside>
  </div>

  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script>
    /* ===================== CONFIG ===================== */
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiaG9tZXByb3MyMDI1IiwiYSI6ImNtZjlyOWdlejAwa2QycnE3cnNibnNvZjIifQ.gGgpxSOWpu2dTZ2N-o8pEQ';

    /* ===================== DEMO DATA ===================== */
    const buyers = [
      { id:'b1', name:'Evergreen Residential LLC', buyer_type:'Flipper', contacts:[{phone:'210-555-0187'}]},
      { id:'b2', name:'Alamo Rentals Group',       buyer_type:'Landlord', contacts:[{phone:'210-555-0142'}]},
      { id:'b3', name:'River City Capital',        buyer_type:'Cash',     contacts:[{phone:'210-555-0199'}]},
      { id:'b4', name:'Hill Country Flips',        buyer_type:'Flipper',  contacts:[{email:'offers@hillcountryflips.com'}]},
    ];
    const properties = [
      { id:'p1', addr1:'112 Blanco Rd', city:'San Antonio', state:'TX', zip:'78212', lat:29.462, lon:-98.501 },
      { id:'p2', addr1:'2744 Briarhurst Dr #38', city:'Houston', state:'TX', zip:'77057', lat:29.741, lon:-95.483 },
      { id:'p3', addr1:'501 Woodlawn Ave', city:'San Antonio', state:'TX', zip:'78201', lat:29.458, lon:-98.514 },
      { id:'p4', addr1:'2803 W Martin St', city:'San Antonio', state:'TX', zip:'78207', lat:29.422, lon:-98.514 },
      { id:'p5', addr1:'133 King William St', city:'San Antonio', state:'TX', zip:'78204', lat:29.410, lon:-98.495 },
      { id:'p6', addr1:'845 S Presa St', city:'San Antonio', state:'TX', zip:'78210', lat:29.411, lon:-98.487 },
    ];
    const events = [
      { id:'e1', buyer_id:'b1', property_id:'p1', event_type:'purchase', event_date:'2025-07-21', price:275000, source:'county' },
      { id:'e2', buyer_id:'b1', property_id:'p3', event_type:'purchase', event_date:'2025-05-10', price:245000, source:'county' },
      { id:'e3', buyer_id:'b1', property_id:'p5', event_type:'purchase', event_date:'2024-12-19', price:310000, source:'mls' },
      { id:'e4', buyer_id:'b2', property_id:'p4', event_type:'purchase', event_date:'2025-03-02', price:190000, source:'county' },
      { id:'e5', buyer_id:'b2', property_id:'p6', event_type:'purchase', event_date:'2024-10-11', price:215000, source:'county' },
      { id:'e6', buyer_id:'b3', property_id:'p1', event_type:'purchase', event_date:'2024-09-20', price:260000, source:'county' },
      { id:'e7', buyer_id:'b4', property_id:'p6', event_type:'purchase', event_date:'2025-08-05', price:330000, source:'mls' },
    ];

    /* ===================== STATE ===================== */
    const INITIAL={lat:29.4241, lon:-98.4936};
    let mode='buyers', center={...INITIAL}, miles=2, months=12;

    const selected = new Set(); // Buyer Search selections

    /* ===================== LOCAL ‚ÄòDB‚Äô (no server) ===================== */
    const LS_BUYER_LIST = 'fr_buyer_list';
    const LS_CONTACTED  = 'fr_contacted_counts';
    const LS_SETTINGS   = 'fr_settings';
    const LS_USER       = 'fr_user';

    function getBuyerList(){
      try{ return JSON.parse(localStorage.getItem(LS_BUYER_LIST)||'[]'); }catch{ return []; }
    }
    function setBuyerList(rows){ localStorage.setItem(LS_BUYER_LIST, JSON.stringify(rows)); }
    function addToBuyerList(row){
      const list = getBuyerList();
      if(!list.find(x=>x.id===row.id)){ list.push(row); setBuyerList(list); }
    }

    function getContacted(){ try{ return JSON.parse(localStorage.getItem(LS_CONTACTED)||'{}'); }catch{ return {}; } }
    function bumpContacted(id){
      const m=getContacted(); m[id]=(m[id]||0)+1; localStorage.setItem(LS_CONTACTED, JSON.stringify(m));
      return m[id];
    }

    function getSettings(){
      try{ return JSON.parse(localStorage.getItem(LS_SETTINGS)||'{}'); }catch{ return {}; }
    }
    function setSettings(s){ localStorage.setItem(LS_SETTINGS, JSON.stringify(s)); }

    function getUser(){
      try{ return JSON.parse(localStorage.getItem(LS_USER)||'null'); }catch{ return null; }
    }
    function setUser(u){ localStorage.setItem(LS_USER, JSON.stringify(u)); }

    /* ===================== HELPERS ===================== */
    function monthsAgo(n){ const d=new Date(); d.setMonth(d.getMonth()-n); return d; }
    function distanceMiles(a,b){
      const R=3958.8,toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function circlePolygon(lon,lat,mi,pts=64){
      const coords=[], R=3958.8, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
      const latR=toRad(lat), lonR=toRad(lon), ang=mi/R;
      for(let i=0;i<=pts;i++){
        const br=(i/pts)*2*Math.PI;
        const lat2=Math.asin(Math.sin(latR)*Math.cos(ang)+Math.cos(latR)*Math.sin(ang)*Math.cos(br));
        const lon2=lonR+Math.atan2(Math.sin(br)*Math.sin(ang)*Math.cos(latR), Math.cos(ang)-Math.sin(latR)*Math.sin(lat2));
        coords.push([toDeg(lon2), toDeg(lat2)]);
      }
      return { type:'Feature', geometry:{type:'Polygon',coordinates:[coords]}, properties:{} };
    }

    function latestInsideCoord(buyerId, cen, mi){
      const since=monthsAgo(months);
      const cand=events.filter(e=>e.buyer_id===buyerId && e.event_type==='purchase' && new Date(e.event_date)>=since)
        .map(e=>{
          const p=properties.find(pp=>pp.id===e.property_id); if(!p) return null;
          const d=distanceMiles(cen,{lat:p.lat,lon:p.lon});
          return d<=mi ? { e, p, d } : null;
        }).filter(Boolean).sort((a,b)=> +new Date(b.e.event_date) - +new Date(a.e.event_date));
      if(!cand.length) return null;
      return [cand[0].p.lon, cand[0].p.lat];
    }

    function computeResults(cen,mi,mo){
      const since=monthsAgo(mo);
      const filtered=events.filter(e=>{
        const p=properties.find(pp=>pp.id===e.property_id); if(!p) return false;
        return e.event_type==='purchase' && new Date(e.event_date)>=since &&
               distanceMiles(cen,{lat:p.lat,lon:p.lon})<=mi;
      });

      const by={};
      filtered.forEach(ev=>{
        const b=buyers.find(bb=>bb.id===ev.buyer_id); if(!b) return;
        const p=properties.find(pp=>pp.id===ev.property_id);
        by[b.id] = by[b.id] || { buyer:b, deals:[], last:new Date(0), lastCoord:null, lastProp:p };
        by[b.id].deals.push(ev);
        const d=new Date(ev.event_date);
        if(d>by[b.id].last){
          by[b.id].last=d;
          by[b.id].lastCoord = p ? [p.lon,p.lat] : null;
          by[b.id].lastProp  = p || by[b.id].lastProp;
        }
      });

      const out = Object.values(by).map(v=>{
        const prices=v.deals.map(d=>d.price).sort((a,b)=>a-b);
        const mid=Math.floor(prices.length/2);
        const median=prices.length%2?prices[mid]:(prices[mid-1]+prices[mid])/2;
        const dist = v.lastProp ? distanceMiles(cen,{lat:v.lastProp.lat,lon:v.lastProp.lon}) : 9999;
        return {
          id:v.buyer.id, name:v.buyer.name, buyer_type:v.buyer.buyer_type,
          contacts:v.buyer.contacts,
          deals:v.deals.length, last:v.last, median, coord:v.lastCoord,
          location: v.lastProp ? `${v.lastProp.city}, ${v.lastProp.state} ${v.lastProp.zip}` : '‚Äî',
          distance: dist
        };
      });

      // temperature score 0-100: recency (40) + frequency (35) + distance (15 inverse) + price-fit placeholder (10)
      const now=Date.now();
      out.forEach(r=>{
        const days=Math.max(1, (now - r.last.getTime()) / (1000*60*60*24));
        const rec=Math.max(0, 100 - Math.min(100, days/3));     // fresher => higher
        const freq=Math.min(100, r.deals*15);                    // more deals => higher
        const distScore=Math.max(0, 100 - Math.min(100, (r.distance/miles)*100)); // closer => higher
        const price=70; // placeholder
        r.temperature = Math.round(0.4*rec + 0.35*freq + 0.15*distScore + 0.1*price);
      });

      return out.sort((a,b)=> b.deals-a.deals || b.last-b.last);
    }

    function colorForType(t){ return t==='Flipper'? '#3b82f6' : t==='Landlord'? '#22c55e' : '#ef4444'; }
    function emojiFor(t){ return t==='Flipper'?'üõ†Ô∏è':(t==='Landlord'?'üè†':'üíµ'); }

    /* ===================== MAP ===================== */
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const mapStyleLight = 'mapbox://styles/mapbox/light-v11';
    const mapStyleDark  = 'mapbox://styles/mapbox/dark-v11';

    let map = new mapboxgl.Map({
      container:'map',
      style: mapStyleLight,
      center:[INITIAL.lon,INITIAL.lat],
      zoom:11
    });
    map.addControl(new mapboxgl.NavigationControl());

    function addRadiusSources(){
      if(map.getSource('radius')) return;
      map.addSource('radius',{ type:'geojson', data:circlePolygon(center.lon,center.lat,miles) });
      map.addLayer({ id:'radius-fill', type:'fill', source:'radius', paint:{ 'fill-color':'#ef4444','fill-opacity':0.08 }});
      map.addLayer({ id:'radius-line', type:'line', source:'radius', paint:{ 'line-color':'#ef4444','line-width':2 }});
    }
    map.on('load',()=>{ addRadiusSources(); refreshAll(true); });
    map.on('click', e=>{ center={lat:e.lngLat.lat, lon:e.lngLat.lng}; refreshAll(true); });

    function switchStyle(){
      const style = document.body.classList.contains('dark') ? mapStyleDark : mapStyleLight;
      map.setStyle(style);
      map.once('style.load',()=>{ addRadiusSources(); refreshAll(false); });
    }

    // DOM markers
    const markerById = new Map();
    function clearMarkers(){
      for(const {marker,popup} of markerById.values()){ popup.remove(); marker.remove(); }
      markerById.clear();
    }
    function buildMarkers(results){
      clearMarkers();
      results.forEach(r=>{
        const coords = r.coord || latestInsideCoord(r.id, center, miles) || [center.lon,center.lat];
        const el = document.createElement('div');
        el.className = 'pin';
        el.textContent = emojiFor(r.buyer_type);
        el.style.backgroundColor = colorForType(r.buyer_type);
        const popup = new mapboxgl.Popup({ closeButton:false, offset: 12 })
          .setHTML(`<div style="font-weight:700">${r.name}</div>
                    <div style="font-size:12px;opacity:.8">${r.buyer_type}</div>
                    <div class="small">Temp: ${r.temperature}%</div>`);
        const marker = new mapboxgl.Marker({ element: el, anchor:'center' }).setLngLat(coords).setPopup(popup).addTo(map);
        el.addEventListener('mouseenter', ()=> marker.togglePopup());
        el.addEventListener('mouseleave', ()=> marker.togglePopup());
        markerById.set(r.id, { marker, popup, coords });
      });
    }

    /* ===================== UI WIRING ===================== */
    const tBuy=document.getElementById('tab-buyers');
    const tHome=document.getElementById('tab-homefull');
    const tSni=document.getElementById('tab-sniping');
    const tList=document.getElementById('tab-list');
    const tSet=document.getElementById('tab-settings');

    const chips = document.getElementById('chips');
    const metricTiles = document.getElementById('metricTiles');
    const searchWrap = document.getElementById('searchWrap');
    const searchContent = document.getElementById('searchContent');
    const listContent = document.getElementById('listContent');
    const settingsContent = document.getElementById('settingsContent');

    function setActive(){
      tBuy.classList.toggle('active',mode==='buyers');
      tHome.classList.toggle('active',mode==='homefull');
      tSni.classList.toggle('active',mode==='sniping');
      tList.classList.toggle('active',mode==='list');
      tSet.classList.toggle('active',mode==='settings');

      document.getElementById('modeChip').textContent =
        mode==='buyers'?'Buyer Search':(mode==='homefull'?'Homefull':(mode==='sniping'?'Wholesaler Sniping':'Buyers List'));

      // Show/hide blocks
      chips.style.display   = (mode==='buyers' || mode==='homefull' || mode==='sniping') ? 'flex' : 'none';
      metricTiles.style.display = (mode==='buyers') ? 'grid' : 'none';
      searchWrap.style.display  = (mode==='buyers' || mode==='homefull' || mode==='sniping') ? 'block' : 'none';
      searchContent.style.display = (mode==='buyers') ? 'block' : 'none';
      listContent.style.display   = (mode==='list') ? 'block' : 'none';
      settingsContent.style.display = (mode==='settings') ? 'block' : 'none';

      if(mode==='list'){ renderBuyersList(); }
    }
    tBuy.onclick=()=>{mode='buyers'; setActive(); refreshAll(false);}
    tHome.onclick=()=>{mode='homefull'; setActive(); refreshAll(false);}
    tSni.onclick=()=>{mode='sniping'; setActive(); refreshAll(false);}
    tList.onclick=()=>{mode='list'; setActive();}
    tSet.onclick=()=>{mode='settings'; setActive();}

    // Dark mode + profile menu
    document.getElementById('darkToggle').onclick = ()=>{
      document.body.classList.toggle('dark');
      document.getElementById('searchBtn').className = 'btn btn-dark';
      switchStyle();
    };
    const profileBtn=document.getElementById('profileBtn');
    const profileMenu=document.getElementById('profileMenu');
    profileBtn.onclick = ()=>{ profileMenu.style.display = profileMenu.style.display==='block' ? 'none' : 'block'; };
    window.addEventListener('click',(e)=>{ if(!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.style.display='none'; });

    document.getElementById('loginBtn').onclick = ()=> showLogin(true);
    document.getElementById('logoutBtn').onclick = ()=>{ setUser(null); alert('Logged out'); };

    // Controls
    document.getElementById('miles').onchange = e=>{ miles=parseFloat(e.target.value); refreshAll(true); };
    document.getElementById('months').onchange = e=>{ months=parseInt(e.target.value,10); refreshAll(false); };

    // search & autocomplete
    const ac=document.getElementById('ac');
    const search=document.getElementById('search');
    document.getElementById('searchBtn').onclick = ()=> doSearch(search.value);
    search.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(search.value); });
    let acTimer=null;
    search.addEventListener('input', ()=>{
      const q=search.value.trim();
      if(!q || q.length<3){ ac.style.display='none'; ac.innerHTML=''; return; }
      clearTimeout(acTimer);
      acTimer=setTimeout(()=>{
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&autocomplete=true&limit=5&country=us`)
          .then(r=>r.json()).then(d=>{
            const feats=d.features||[];
            if(!feats.length){ ac.style.display='none'; ac.innerHTML=''; return; }
            ac.innerHTML = feats.map((f,i)=>`<button data-i="${i}">${f.place_name}</button>`).join('');
            ac.style.display='block';
            Array.from(ac.querySelectorAll('button')).forEach((b,idx)=>{
              b.onclick = ()=> doSearch(feats[idx].place_name);
            });
          }).catch(()=>{});
      }, 200);
    });
    function doSearch(q){
      const s=q.trim(); if(!s) return;
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(s)}.json?access_token=${MAPBOX_TOKEN}&limit=1&country=us`)
        .then(r=>r.json()).then(d=>{
          const f=d.features?.[0]; if(!f) return;
          const [lon,lat]=f.center; center={lat,lon};
          search.value=f.place_name; ac.style.display='none'; ac.innerHTML='';
          refreshAll(true);
        }).catch(()=>{});
    }

    /* ===================== Buyer Search render ===================== */
    const resultsDiv = document.getElementById('results');
    const selectAllEl = document.getElementById('selectAll');
    const bulkBtn = document.getElementById('bulkSkip');
    const sortBy = document.getElementById('sortBy');

    function updateBulkUI(){
      bulkBtn.disabled = selected.size===0;
      const total = resultsDiv.querySelectorAll('.row[data-id]').length;
      selectAllEl.indeterminate = selected.size>0 && selected.size < total;
      selectAllEl.checked = selected.size>0 && selected.size === total;
    }

    selectAllEl.addEventListener('change', ()=>{
      const check = selectAllEl.checked;
      selected.clear();
      resultsDiv.querySelectorAll('input[type="checkbox"][data-id]').forEach(cb=>{
        cb.checked = check;
        if(check) selected.add(cb.dataset.id);
      });
      updateBulkUI();
    });

    sortBy.addEventListener('change', ()=> refreshAll(false));

    bulkBtn.addEventListener('click', async ()=>{
      const ids=[...selected];
      const res = getCurrentResults();
      const payload = res.filter(r=>ids.includes(r.id)).map(toPayload);
      await enqueueSkiptrace(payload);
      ids.forEach(id=> bumpContacted(id));
      refreshAll(false);
    });

    function getCurrentResults(){
      const res = computeResults(center,miles,months);
      const mode = sortBy.value;
      // Sorting modes
      if(mode==='distance') res.sort((a,b)=>a.distance-b.distance);
      else if(mode==='temperature') res.sort((a,b)=>b.temperature-a.temperature);
      else if(mode==='contacted'){
        const c=getContacted();
        res.sort((a,b)=>(c[b.id]||0)-(c[a.id]||0));
      }else if(mode==='last'){
        res.sort((a,b)=> b.last - a.last); // newest first
      }else if(mode==='deals'){
        res.sort((a,b)=> b.deals - a.deals);
      }
      return res;
    }

    function refreshAll(fly){
      // chips
      document.getElementById('chipMiles').textContent=`${miles} mi`;
      document.getElementById('chipMonths').textContent=`${months} mo`;
      document.getElementById('tileMonthsA').textContent=months;
      document.getElementById('tileMonthsB').textContent=months;

      const res=getCurrentResults();

      // metrics
      const avg=a=>Math.round((a.reduce((x,y)=>x+y,0))/(a.length||1));
      const flips=res.filter(r=>r.buyer_type==='Flipper').map(r=>r.median);
      const lands=res.filter(r=>r.buyer_type==='Landlord').map(r=>r.median);
      document.getElementById('avgFlip').textContent=`$${avg(flips).toLocaleString()}`;
      document.getElementById('avgLand').textContent=`$${avg(lands).toLocaleString()}`;

      // sidebar list
      selected.clear();
      resultsDiv.innerHTML='';
      if(mode==='buyers'){
        if(!res.length){
          resultsDiv.innerHTML=`<div class="row muted">No active buyers found within ${miles} mi. Try widening the radius or time window.</div>`;
        }else{
          res.forEach(r=>{
            const color = r.buyer_type==='Flipper'?'blue':(r.buyer_type==='Landlord'?'green':'red');
            const contacted = getContacted()[r.id]||0;
            const row=document.createElement('div'); row.className='row'; row.dataset.id=r.id;
            const tempColor = r.temperature>=75? '#dc2626' : r.temperature>=50? '#f59e0b' : '#22c55e';
            row.innerHTML=`
              <div class="top" style="gap:10px">
                <label style="display:flex;align-items:center;gap:8px">
                  <input type="checkbox" data-id="${r.id}"/>
                  <div>${r.name}</div>
                </label>
                <span class="badge ${color}">${r.buyer_type}</span>
              </div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <span class="therm-wrap">
                  <span>üå°Ô∏è Buyer Score</span>
                  <span class="therm-bar"><span class="therm-fill" style="width:${r.temperature}%; background:${tempColor}"></span></span>
                  <b>${r.temperature}%</b>
                </span>
                <span class="badge" style="background:${r.buyer_type==='Flipper'?'#3b82f6':'#22c55e'};border-color:${r.buyer_type==='Flipper'?'#3b82f6':'#22c55e'};color:#fff;">${r.deals} deals</span>
                <span class="badge">üìç ${r.distance.toFixed(2)} mi</span>
                <span class="muted"> Last: ${r.last.toLocaleDateString()}</span>
                <span class="muted"> Median: $${r.median.toLocaleString()}</span>
                <span class="muted"> ${r.location}</span>
                <span class="muted"> Contacted: ${contacted}</span>
              </div>
              <div class="actions">
                <button class="btn btn-ghost" data-skip="${r.id}">Skip Trace</button>
                <button class="btn btn-dark" data-add="${r.id}">+ Add to Buyers List</button>
              </div>`;

            // hover -> show popup + ease map
            row.addEventListener('mouseenter', ()=>{
              const m = markerById.get(r.id); if(!m) return;
              m.marker.togglePopup(); map.easeTo({ center:m.coords, duration:500, zoom:Math.max(map.getZoom(),11) });
            });
            row.addEventListener('mouseleave', ()=>{
              const m = markerById.get(r.id); if(!m) return; m.marker.togglePopup();
            });

            // checkbox
            row.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
              const id = e.target.dataset.id;
              if(e.target.checked) selected.add(id); else selected.delete(id);
              updateBulkUI();
            });

            // skiptrace
            row.querySelector('[data-skip]').addEventListener('click', async ()=>{
              await enqueueSkiptrace([toPayload(r)]);
              bumpContacted(r.id);
              refreshAll(false);
            });
            // add to list
            row.querySelector('[data-add]').addEventListener('click', ()=>{
              addToBuyerList({
                id:r.id, name:r.name, buyer_type:r.buyer_type, deals:r.deals,
                last_deal:r.last.toISOString(), median:r.median,
                location:r.location, phones:collectPhones(r), emails:collectEmails(r), vip:false
              });
              alert(`${r.name} added to Buyers List.`);
            });

            resultsDiv.appendChild(row);
          });
        }
      }else if(mode==='homefull'){
        resultsDiv.innerHTML=`
          <div class="row"><b>Homefull</b><div class="muted">AI-OCR on active & sold listings; agent leaderboard.</div></div>
          <div class="row">
            <div class="top"><div>506 Washington Blvd</div><span class="badge">Flip-Like 0.81</span></div>
            <div class="muted">Staged ‚Ä¢ LVP ‚Ä¢ Subway tile ‚Ä¢ Matte black</div>
            <div class="muted" style="margin-top:6px;">Agent: Leslie Elrod (432) 517-0038</div>
            <div class="actions"><button class="btn btn-ghost">Call Agent</button><button class="btn btn-dark">Skiptrace Owner</button></div>
          </div>`;
      }else if(mode==='sniping'){
        resultsDiv.innerHTML=`
          <div class="row"><b>Wholesaler Sniping</b><div class="muted">Grantor ‚Üí Grantee repeat pairs (last ${months} mo).</div></div>
          <div class="row">
            <div class="top"><div>ABC Investments LLC ‚Üí Evergreen Homes LLC</div><span class="badge">6 in 12 mo</span></div>
            <div class="muted">last_deal: 2025-06-11</div>
            <div class="actions"><button class="btn btn-ghost">Skiptrace Buyer</button><button class="btn btn-dark">+ Add to Buyers List</button></div>
          </div>`;
      }

      updateBulkUI();

      // markers + radius
      buildMarkers(res);
      const radiusSrc=map.getSource('radius'); if(radiusSrc) radiusSrc.setData(circlePolygon(center.lon,center.lat,miles));
      if(fly) map.flyTo({center:[center.lon,center.lat], zoom:Math.max(map.getZoom(),11), essential:true});
    }

    function toPayload(r){
      return {
        id:r.id, name:r.name, buyer_type:r.buyer_type,
        phones:collectPhones(r), emails:collectEmails(r),
        deals:r.deals, last_deal:r.last.toISOString(), median:r.median,
        location:r.location, temperature:r.temperature, distance:r.distance
      };
    }
    function collectPhones(r){ return (r.contacts||[]).map(x=>x.phone).filter(Boolean); }
    function collectEmails(r){ return (r.contacts||[]).map(x=>x.email).filter(Boolean); }

    // Fake skiptrace (client-only) ‚Äî still bumps "contacted"
    async function enqueueSkiptrace(buyers){
      const u=getUser(); if(!u){ showLogin(true); return; }
      await new Promise(r=>setTimeout(r,400));
      alert(`Skiptrace queued for:\n\n` + buyers.map(b=>`${b.name} (${(b.phones||[]).concat(b.emails||[]).join(' / ')||'no contact on file'})`).join('\n'));
    }

    /* ===================== Buyers List ===================== */
    const locFilter = document.getElementById('locFilter');
    const vipOnly   = document.getElementById('vipOnly');
    const exportCsv = document.getElementById('exportCsv');
    const exportCrm = document.getElementById('exportCrm');
    const listSelectAll = document.getElementById('listSelectAll');
    const listTbody = document.getElementById('listTbody');

    let listSelected = new Set();

    function renderBuyersList(){
      const q = (locFilter.value||'').toLowerCase();
      const onlyVip = vipOnly.checked;
      const rows = getBuyerList()
        .filter(r => !q || (r.location||'').toLowerCase().includes(q))
        .filter(r => !onlyVip || r.vip===true);

      listSelected.clear();
      listSelectAll.checked=false;

      listTbody.innerHTML='';
      if(!rows.length){
        listTbody.innerHTML = `<tr><td colspan="9" class="small muted" style="padding:16px">No buyers saved yet.</td></tr>`;
        return;
      }
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const contacted = getContacted()[r.id]||0;
        tr.innerHTML=`
          <td><input type="checkbox" data-id="${r.id}"/></td>
          <td>${r.name}</td>
          <td>${r.buyer_type}</td>
          <td>${r.deals||0}</td>
          <td>${r.last_deal? new Date(r.last_deal).toLocaleDateString():'‚Äî'}</td>
          <td>$${(r.median||0).toLocaleString()}</td>
          <td>${r.location||'‚Äî'}</td>
          <td><span class="star ${r.vip?'vip':''}" data-vip="${r.id}">${r.vip?'‚òÖ':'‚òÜ'}</span></td>
          <td>${contacted}</td>
        `;
        // select
        tr.querySelector('[data-id]').addEventListener('change',(e)=>{
          const id=e.target.dataset.id;
          if(e.target.checked) listSelected.add(id); else listSelected.delete(id);
          listSelectAll.checked = listSelected.size && listSelected.size===rows.length;
        });
        // VIP toggle
        tr.querySelector('[data-vip]').addEventListener('click',()=>{
          const list=getBuyerList();
          const idx=list.findIndex(x=>x.id===r.id);
          if(idx>=0){ list[idx].vip = !list[idx].vip; setBuyerList(list); renderBuyersList(); }
        });

        listTbody.appendChild(tr);
      });
    }

    listSelectAll.addEventListener('change', ()=>{
      const rows = [...listTbody.querySelectorAll('input[type="checkbox"][data-id]')];
      listSelected.clear();
      if(listSelectAll.checked) rows.forEach(cb=>{ cb.checked=true; listSelected.add(cb.dataset.id); });
      else rows.forEach(cb=> cb.checked=false);
    });
    locFilter.addEventListener('input', renderBuyersList);
    vipOnly.addEventListener('change', renderBuyersList);

    exportCsv.addEventListener('click', ()=>{
      const q=(locFilter.value||'').toLowerCase(), onlyVip=vipOnly.checked;
      const rows = getBuyerList()
        .filter(r => !q || (r.location||'').toLowerCase().includes(q))
        .filter(r => !onlyVip || r.vip===true)
        .filter(r => !listSelected.size || listSelected.has(r.id));

      if(!rows.length){ alert('Nothing to export.'); return; }
      const header=['id','name','type','deals','last_deal','median','location','vip','phones','emails'];
      const csv=[header.join(',')].concat(rows.map(r=>{
        const phones=(r.phones||[]).join('|'); const emails=(r.emails||[]).join('|');
        return [r.id, r.name, r.buyer_type, r.deals||0, r.last_deal||'', r.median||0, `"${r.location||''}"`, r.vip?1:0, `"${phones}"`, `"${emails}"`].join(',');
      })).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='buyers_list.csv'; a.click();
      URL.revokeObjectURL(a.href);
    });

    exportCrm.addEventListener('click', async ()=>{
      const settings=getSettings();
      if(!settings.webhookUrl){ alert('Set a Webhook URL in Settings first.'); return; }
      const rows = getBuyerList().filter(r=>!listSelected.size || listSelected.has(r.id));
      if(!rows.length){ alert('Select some buyers first (or use Select All).'); return; }
      try{
        const resp=await fetch(settings.webhookUrl,{method:'POST', headers:{
          'Content-Type':'application/json',
          ...(settings.apiKey? {'X-API-Key': settings.apiKey} : {})
        }, body:JSON.stringify({ source:'flip-radar', buyers:rows })});
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        alert('Sent to CRM webhook.');
      }catch(err){
        alert('Failed to call webhook: '+err.message);
      }
    });

    /* ===================== Settings ===================== */
    const webhookUrl=document.getElementById('webhookUrl');
    const apiKey=document.getElementById('apiKey');
    const saveSettings=document.getElementById('saveSettings');
    const testWebhook=document.getElementById('testWebhook');

    function loadSettingsUI(){
      const s=getSettings();
      webhookUrl.value=s.webhookUrl||'';
      apiKey.value=s.apiKey||'';
    }
    saveSettings.addEventListener('click', ()=>{
      setSettings({ webhookUrl:webhookUrl.value.trim(), apiKey:apiKey.value.trim() });
      alert('Saved.');
    });
    testWebhook.addEventListener('click', async ()=>{
      const s=getSettings();
      if(!s.webhookUrl){ alert('Set a Webhook URL first.'); return; }
      try{
        const resp=await fetch(s.webhookUrl,{method:'POST', headers:{
          'Content-Type':'application/json',
          ...(s.apiKey? {'X-API-Key': s.apiKey} : {})
        }, body:JSON.stringify({ ping:'ok', ts:Date.now(), from:'flip-radar-test' })});
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        alert('Webhook test sent.');
      }catch(err){ alert('Webhook test failed: '+err.message); }
    });

    /* ===================== Login (client-only mock) ===================== */
    function showLogin(redirectAfter){
      const name=prompt('Enter your name (for assigning actions):');
      if(!name) return;
      setUser({ name });
      alert(`Logged in as ${name}`);
      if(redirectAfter && mode==='list') renderBuyersList();
    }

    /* ===================== INIT ===================== */
    function getCurrentResults(){ return computeResults(center,miles,months); } // placeholder overwritten above
    setActive();
    loadSettingsUI();

  </script>
</body>
</html>
