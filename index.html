<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Flip Radar</title>
<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  :root{
    --brand:#b91c1c;         /* darker red */
    --brand-700:#991b1b;
    --text:#0f172a;          /* slate-900 */
    --muted:#64748b;         /* slate-500 */
    --line:#e2e8f0;          /* slate-200 */
    --card:#ffffff;
    --chip:#f1f5f9;          /* slate-100 */
    --navy:#0c1220;          /* dark header/search */
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
  }
  .dark{
    --text:#e5e7eb;
    --muted:#94a3b8;
    --line:#141d33;
    --card:#0b0f1a;
    --chip:#0f172a;
    background:#0b0f1a;
    color:var(--text);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  button{cursor:pointer}
  a{color:inherit;text-decoration:none}

  /* Top bar */
  .topbar{
    position:fixed; inset:0 0 auto 0; height:56px; z-index:50;
    background:#fff; color:#000; border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; padding:0 14px;
  }
  .dark .topbar{ background:var(--navy); color:#fff; border-bottom-color:#141d33; }
  .top-left{display:flex; align-items:center; gap:12px}
  .logo{display:flex; align-items:center; gap:8px}
  .logo svg{height:22px; width:22px}
  .logo .word{font-weight:800; letter-spacing:.2px; color:var(--brand)}
  .tabs{display:flex; gap:6px}
  .tab{
    color:#0f172a; background:#fff; border:1px solid var(--line);
    padding:8px 12px; border-radius:10px; font-weight:600;
    transition:.15s;
  }
  .tab:hover{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .dark .tab{ background:var(--navy); color:#cbd5e1; border-color:#1f2a44 }
  .dark .tab:hover, .dark .tab.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

  .right-actions{display:flex; align-items:center; gap:8px}
  .switch{border:1px solid var(--line); border-radius:10px; padding:8px 12px; background:#fff}
  .dark .switch{ background:var(--navy); color:#fff; border-color:#1f2a44 }

  .profile{display:flex;align-items:center;gap:8px}
  .avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
          background:var(--brand);color:#fff;font-weight:700}
  .menu{position:absolute;right:12px;top:48px;background:var(--card);border:1px solid var(--line);border-radius:10px;display:none;min-width:220px;z-index:60}
  .menu .mi{padding:10px 12px;border-bottom:1px solid var(--line)}
  .menu .mi:last-child{border-bottom:0}
  .menu .mi:hover{background:#f8fafc}
  .dark .menu .mi:hover{background:#0f172a}

  /* Combined search */
  .search-wrap{ position:fixed; z-index:30; left:50%; transform:translateX(-50%); top:72px; width:min(1100px,95vw) }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:16px;
         box-shadow:0 1px 2px rgba(0,0,0,.06),0 10px 25px rgba(0,0,0,.06); padding:10px }
  .dark .card{ background:var(--navy); border-color:#1f2a44; box-shadow:none }
  .row-flex{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .grow{ flex:1 1 360px }      /* search input grows to keep everything on one row */
  .input{ width:100%; border:1px solid var(--line); background:transparent; color:var(--text);
          border-radius:10px; padding:10px 12px; font-size:14px; outline:0 }
  .dark .input{ border-color:#1f2a44 }
  .sel{ border:1px solid var(--line); background:transparent; color:var(--text);
        border-radius:10px; padding:9px 10px; min-width:130px }
  .dark .sel{ border-color:#1f2a44 }
  .label{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px }
  .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px;
        border-radius:12px; border:1px solid var(--line); white-space:nowrap }
  .btn-red{ background:var(--brand); color:#fff; border-color:var(--brand) }
  .btn-red:hover{ background:var(--brand-700); border-color:var(--brand-700) }

  .ac{ position:absolute; left:10px; right:10px; top:calc(100% + 8px); max-height:280px;
       overflow:auto; border-radius:12px; display:none; z-index:40 }
  .ac button{ display:block; width:100%; text-align:left; padding:10px 12px; border:0;
              background:var(--card); color:var(--text); cursor:pointer; border-bottom:1px solid var(--line) }
  .ac button:last-child{ border-bottom:0 }
  .ac button:hover{ background:#f3f4f6 }
  .dark .ac button:hover{ background:#0f172a }

  /* Layout */
  .app{ height:100%; display:grid; grid-template-columns:1fr 420px; padding-top:56px }
  @media (max-width: 980px){ .app{ grid-template-columns:1fr } }
  #map{ width:100%; height:100% }

  .sidebar{ border-left:1px solid var(--line); background:var(--card); height:100vh; overflow:auto; position:relative }
  .dark .sidebar{ border-left-color:#1f2a44 }
  @media (max-width: 980px){ .sidebar{ height:auto } }
  .chips{ display:flex; gap:6px; align-items:center; padding:10px; border-bottom:1px solid var(--line); justify-content:space-between }
  .chipset{ display:flex; gap:6px; align-items:center }
  .chip{ font-size:12px; background:var(--chip); border:1px solid var(--line); padding:4px 8px; border-radius:999px }
  .count{ font-size:12px; color:var(--muted) }

  .sortbar{ display:flex; gap:8px; align-items:center; padding:10px; border-bottom:1px solid var(--line) }
  .sortbar .sel{ min-width:220px }

  .tile-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:10px; border-bottom:1px solid var(--line) }
  @media (max-width: 420px){ .tile-grid{ grid-template-columns:1fr } }
  .tile{ padding:10px }

  .row{ padding:12px; border-bottom:1px solid var(--line) }
  .row .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-weight:600 }
  .badge{ font-size:11px; border:1px solid var(--line); padding:4px 8px; border-radius:999px }
  .badge.blue{ background:#3b82f6; color:#fff; border-color:#3b82f6 }
  .badge.green{ background:#22c55e; color:#fff; border-color:#22c55e }
  .badge.red{ background:#ef4444; color:#fff; border-color:#ef4444 }
  .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px }
  .muted{ color:var(--muted) }

  /* Emoji marker styling */
  .pin{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:18px;line-height:1;background:#fff;border:1px solid rgba(255,255,255,0.85);
    box-shadow:0 2px 6px rgba(0,0,0,.25); color:#fff; user-select:none
  }

  /* temperature bar */
  .temp-wrap{display:flex;align-items:center;gap:8px;margin-top:6px}
  .temp-track{flex:1;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .dark .temp-track{background:#1f2a44}
  .temp-fill{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#f59e0b,#ef4444)}
  .temp-emoji{font-size:16px}

  /* bulk toolbar */
  .bulkbar{ position:sticky; top:0; z-index:5; background:var(--card); border-bottom:1px solid var(--line);
            display:flex; align-items:center; justify-content:space-between; padding:10px 12px }

  /* Drawer (settings) */
  .drawer{position:fixed;right:-420px;top:56px;bottom:0;width:420px;background:var(--card);border-left:1px solid var(--line);
          transition:right .2s ease; z-index:55; padding:14px; overflow:auto}
  .drawer.open{right:0}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .field input{padding:10px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text)}
</style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="top-left">
      <a href="#" class="logo" aria-label="Flip Radar">
        <!-- red radar SVG -->
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="9" stroke="var(--brand)" stroke-width="2"/>
          <path d="M12 12 L19 7" stroke="var(--brand)" stroke-width="2" stroke-linecap="round"/>
          <circle cx="19" cy="7" r="2" fill="var(--brand)"/>
        </svg>
        <span class="word">Flip&nbsp;Radar</span>
      </a>
      <div class="tabs">
        <button id="tab-buyers" class="tab active">Buyer Search</button>
        <button id="tab-homefull" class="tab">Homefull</button>
        <button id="tab-sniping" class="tab">Wholesaler Sniping</button>
        <button id="tab-list" class="tab">Buyers List</button>
      </div>
    </div>
    <div class="right-actions">
      <div class="profile">
        <div id="avatar" class="avatar">FR</div>
        <button id="profileBtn" class="switch">☰</button>
        <div id="profileMenu" class="menu">
          <div class="mi" id="miLogin">Login</div>
          <div class="mi" id="miSettings">Settings</div>
          <div class="mi" id="miLogout">Logout</div>
        </div>
      </div>
      <button id="darkToggle" class="switch" title="Toggle dark mode">🌙</button>
    </div>
  </div>

  <!-- SETTINGS DRAWER -->
  <div id="drawer" class="drawer">
    <h3 style="margin:6px 0 12px 0">Settings</h3>
    <div class="field">
      <label>BatchData Webhook (bulk skiptrace)</label>
      <input id="wh-batch" placeholder="https://your-worker/skiptrace"/>
    </div>
    <div class="field">
      <label>Email Webhook (SendGrid)</label>
      <input id="wh-email" placeholder="https://your-worker/send-email"/>
    </div>
    <div class="field">
      <label>SMS Webhook</label>
      <input id="wh-sms" placeholder="https://your-worker/sms"/>
    </div>
    <div class="field">
      <label>RVM Webhook</label>
      <input id="wh-rvm" placeholder="https://your-worker/rvm"/>
    </div>
    <div class="field">
      <label>CRM Webhook (Export to CRM)</label>
      <input id="wh-crm" placeholder="https://your-worker/crm"/>
    </div>
    <div class="field">
      <label>Apollo Proxy URL (optional)</label>
      <input id="wh-apollo" placeholder="https://your-worker/apollo"/>
    </div>
    <button id="saveSettings" class="btn btn-red">Save Settings</button>
  </div>

  <!-- SEARCH + FILTERS -->
  <div class="search-wrap">
    <div class="card" style="position:relative">
      <div class="row-flex">
        <div class="grow">
          <input id="search" class="input" placeholder="Search address"/>
        </div>
        <label class="label">
          Miles
          <select id="miles" class="sel">
            <option>1</option><option selected>2</option><option>3</option><option>5</option><option>10</option><option>15</option>
          </select>
        </label>
        <label class="label">
          Timeline
          <select id="months" class="sel">
            <option value="12" selected>Last 12 mo</option>
            <option value="24">Last 24 mo</option>
          </select>
        </label>
        <button id="searchBtn" class="btn btn-red">Search</button>
      </div>
      <div id="ac" class="card ac"></div>
    </div>
  </div>

  <div class="app">
    <div id="map"></div>

    <aside class="sidebar" id="sidebar">
      <div class="chips">
        <div class="chipset">
          <span class="chip" id="modeChip">Buyer Search</span>
          <span class="chip" id="chipMiles">2 mi</span>
          <span class="chip" id="chipMonths">12 mo</span>
        </div>
        <div class="count"><span id="resultCount">0</span> results</div>
      </div>

      <!-- Sort bar -->
      <div class="sortbar" id="sortbar">
        <label class="label" style="margin:0">
          Sort by
          <select id="sortBy" class="sel">
            <option value="score">Buyer Score (hot → cold)</option>
            <option value="distance">Distance (near → far)</option>
            <option value="contacted">Most Contacted</option>
            <option value="recent">Most Recent Purchase</option>
            <option value="deals">Most Deals</option>
          </select>
        </label>
      </div>

      <!-- metric tiles (only Buyer Search mode) -->
      <div class="tile-grid" id="metricTiles">
        <div class="card tile">
          <div style="font-weight:600">🔨 Flippers</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgFlip" style="font-weight:700;font-size:18px;">$—</div>
          <div class="muted" style="font-size:12px;">activity last <span id="tileMonthsA">12</span> mo</div>
        </div>
        <div class="card tile">
          <div style="font-weight:600">🏠 Landlords</div>
          <div class="muted" style="margin-top:6px;font-size:12px;">avg price</div>
          <div id="avgLand" style="font-weight:700;font-size:18px;">$—</div>
          <div class="muted" style="font-size:12px;">activity last <span id="tileMonthsB">12</span> mo</div>
        </div>
      </div>

      <!-- bulk toolbar -->
      <div class="bulkbar" id="bulkbar">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="selectAll"/>
          <span class="muted">Select all</span>
        </label>
        <div style="display:flex;gap:8px">
          <button id="bulkSkip" class="btn btn-red" disabled>Skip Trace Selected</button>
        </div>
      </div>

      <div id="results"></div>
      <div id="buyersListView" style="display:none;padding:10px"></div>
    </aside>
  </div>

  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
  <script>
    /* ===================== CONFIG ===================== */
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiaG9tZXByb3MyMDI1IiwiYSI6ImNtZjlyOWdlejAwa2QycnE3cnNibnNvZjIifQ.gGgpxSOWpu2dTZ2N-o8pEQ'; // your pk token

    /* ===================== DEMO DATA ===================== */
    const buyers = [
      { id:'b1', name:'Evergreen Residential LLC', buyer_type:'Flipper', contacts:[{phone:'210-555-0187'}], contacted: 2 },
      { id:'b2', name:'Alamo Rentals Group',      buyer_type:'Landlord', contacts:[{phone:'210-555-0142'}], contacted: 0 },
      { id:'b3', name:'River City Capital',       buyer_type:'Cash',     contacts:[{phone:'210-555-0199'}], contacted: 1 },
      { id:'b4', name:'Hill Country Flips',       buyer_type:'Flipper',  contacts:[{email:'offers@hillcountryflips.com'}], contacted: 0 },
    ];
    const properties = [
      { id:'p1', addr1:'112 Blanco Rd', city:'San Antonio', state:'TX', zip:'78212', lat:29.462, lon:-98.501 },
      { id:'p2', addr1:'2744 Briarhurst Dr #38', city:'Houston', state:'TX', zip:'77057', lat:29.741, lon:-95.483 },
      { id:'p3', addr1:'501 Woodlawn Ave', city:'San Antonio', state:'TX', zip:'78201', lat:29.458, lon:-98.514 },
      { id:'p4', addr1:'2803 W Martin St', city:'San Antonio', state:'TX', zip:'78207', lat:29.422, lon:-98.514 },
      { id:'p5', addr1:'133 King William St', city:'San Antonio', state:'TX', zip:'78204', lat:29.410, lon:-98.495 },
      { id:'p6', addr1:'845 S Presa St', city:'San Antonio', state:'TX', zip:'78210', lat:29.411, lon:-98.487 },
    ];
    const events = [
      { id:'e1', buyer_id:'b1', property_id:'p1', event_type:'purchase', event_date:'2025-07-21', price:275000, source:'county' },
      { id:'e2', buyer_id:'b1', property_id:'p3', event_type:'purchase', event_date:'2025-05-10', price:245000, source:'county' },
      { id:'e3', buyer_id:'b1', property_id:'p5', event_type:'purchase', event_date:'2024-12-19', price:310000, source:'mls' },
      { id:'e4', buyer_id:'b2', property_id:'p4', event_type:'purchase', event_date:'2025-03-02', price:190000, source:'county' },
      { id:'e5', buyer_id:'b2', property_id:'p6', event_type:'purchase', event_date:'2024-10-11', price:215000, source:'county' },
      { id:'e6', buyer_id:'b3', property_id:'p1', event_type:'purchase', event_date:'2024-09-20', price:260000, source:'county' },
      { id:'e7', buyer_id:'b4', property_id:'p6', event_type:'purchase', event_date:'2025-08-05', price:330000, source:'mls' },
    ];

    /* ===================== STATE ===================== */
    const INITIAL={lat:29.4241, lon:-98.4936};
    let mode='buyers', center={...INITIAL}, miles=2, months=12;
    let sortBy='score';
    const selected = new Set(); // for bulk selection
    const savedBuyers = JSON.parse(localStorage.getItem('flipradar_list')||'[]'); // {id,name,type,city,state,vip:boolean}

    const settings = {
      batch: localStorage.getItem('wh_batch')||'',
      email: localStorage.getItem('wh_email')||'',
      sms: localStorage.getItem('wh_sms')||'',
      rvm: localStorage.getItem('wh_rvm')||'',
      crm: localStorage.getItem('wh_crm')||'',
      apollo: localStorage.getItem('wh_apollo')||'',
    };

    const user = { name: localStorage.getItem('user_name') || '' };

    /* ===================== HELPERS ===================== */
    function monthsAgo(n){ const d=new Date(); d.setMonth(d.getMonth()-n); return d; }
    function distanceMiles(a,b){
      const R=3958.8,toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function circlePolygon(lon,lat,mi,pts=64){
      const coords=[], R=3958.8, toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
      const latR=toRad(lat), lonR=toRad(lon), ang=mi/R;
      for(let i=0;i<=pts;i++){
        const br=(i/pts)*2*Math.PI;
        const lat2=Math.asin(Math.sin(latR)*Math.cos(ang)+Math.cos(latR)*Math.sin(ang)*Math.cos(br));
        const lon2=lonR+Math.atan2(Math.sin(br)*Math.sin(ang)*Math.cos(latR), Math.cos(ang)-Math.sin(latR)*Math.sin(lat2));
        coords.push([toDeg(lon2), toDeg(lat2)]);
      }
      return { type:'Feature', geometry:{type:'Polygon',coordinates:[coords]}, properties:{} };
    }

    // Compute results strictly within radius; include latest inside-radius coord
    function computeResults(cen,mi,mo){
      const since=monthsAgo(mo);
      const filtered=events.filter(e=>{
        const p=properties.find(pp=>pp.id===e.property_id); if(!p) return false;
        return e.event_type==='purchase' && new Date(e.event_date)>=since &&
               distanceMiles(cen,{lat:p.lat,lon:p.lon})<=mi;
      });

      const by={};
      filtered.forEach(ev=>{
        const b=buyers.find(bb=>bb.id===ev.buyer_id); if(!b) return;
        by[b.id] = by[b.id] || { buyer:b, deals:[], last:new Date(0), lastCoord:null };
        by[b.id].deals.push(ev);
        const d=new Date(ev.event_date);
        if(d>by[b.id].last){
          by[b.id].last=d;
          const p=properties.find(pp=>pp.id===ev.property_id);
          by[b.id].lastCoord = p ? [p.lon,p.lat] : null; // latest INSIDE-RADIUS coord
        }
      });

      const out = Object.values(by).map(v=>{
        const prices=v.deals.map(d=>d.price).sort((a,b)=>a-b);
        const mid=Math.floor(prices.length/2);
        const median=prices.length%2?prices[mid]:(prices[mid-1]+prices[mid])/2;
        // distance from center to latest coord
        const dmi = v.lastCoord ? distanceMiles({lat:cen.lat,lon:cen.lon},{lat:v.lastCoord[1],lon:v.lastCoord[0]}) : 999;
        const buyerInfo = v.buyer;
        return {
          id: buyerInfo.id,
          name: buyerInfo.name,
          buyer_type: buyerInfo.buyer_type,
          contacts: buyerInfo.contacts,
          contacted: buyerInfo.contacted||0,
          deals: v.deals.length,
          last: v.last,
          median,
          coord: v.lastCoord,
          dist: dmi
        };
      });

      return out;
    }

    // Buyer Score: distance (closer is hotter), frequency (more deals hotter),
    // recency (recent purchase hotter). 0–100%
    function buyerScore(r, milesMax){
      const dScore = Math.max(0, 100 * (1 - Math.min(1, r.dist / Math.max(0.1, milesMax)))); // closer → 100
      const fScore = Math.min(100, r.deals * 20); // 5+ deals caps to 100
      const days = Math.max(1,(Date.now()-r.last.getTime())/(1000*60*60*24));
      const recScore = Math.max(0, 100 - Math.min(100, days / 3)); // fresher → closer to 100
      // weights: distance 35%, frequency 35%, recency 30%
      const s = 0.35*dScore + 0.35*fScore + 0.30*recScore;
      return Math.round(s);
    }
    const tempEmoji = (score)=> score>=75?'🌡️🔥': score>=50?'🌡️':'🌡️❄️';

    /* ===================== MAP ===================== */
    mapboxgl.accessToken = MAPBOX_TOKEN;
    const mapStyleLight = 'mapbox://styles/mapbox/light-v11';
    const mapStyleDark  = 'mapbox://styles/mapbox/dark-v11';

    let map = new mapboxgl.Map({
      container:'map',
      style: mapStyleLight,
      center:[INITIAL.lon,INITIAL.lat],
      zoom:11
    });
    map.addControl(new mapboxgl.NavigationControl());

    function addRadiusSources(){
      if(map.getSource('radius')) return;
      map.addSource('radius',{ type:'geojson', data:circlePolygon(center.lon,center.lat,miles) });
      map.addLayer({ id:'radius-fill', type:'fill', source:'radius', paint:{ 'fill-color':'#ef4444','fill-opacity':0.08 }});
      map.addLayer({ id:'radius-line', type:'line', source:'radius', paint:{ 'line-color':'#ef4444','line-width':2 }});
    }
    map.on('load',()=>{ addRadiusSources(); refreshAll(true); });
    map.on('click', e=>{ center={lat:e.lngLat.lat, lon:e.lngLat.lng}; refreshAll(true); });

    function switchStyle(){
      const style = document.body.classList.contains('dark') ? mapStyleDark : mapStyleLight;
      map.setStyle(style);
      map.once('style.load',()=>{ addRadiusSources(); refreshAll(false); });
    }

    // DOM markers
    const markerById = new Map();
    function clearMarkers(){
      for(const {marker,popup} of markerById.values()){ popup.remove(); marker.remove(); }
      markerById.clear();
    }
    const emojiFor = t => t==='Flipper'?'🛠️':(t==='Landlord'?'🏠':'💵');
    const colorFor = (t) => (t === 'Flipper' ? '#3b82f6' : t === 'Landlord' ? '#22c55e' : '#ef4444');
    const labelFor = (t) => (t === 'Flipper' ? 'Flipper' : t === 'Landlord' ? 'Landlord' : 'Cash');

    function buildMarkers(results){
      clearMarkers();
      results.forEach(r=>{
        const coords = r.coord || [center.lon,center.lat];

        // marker element with colored circular background
        const el = document.createElement('div');
        el.className = 'pin';
        el.textContent = emojiFor(r.buyer_type);
        el.style.backgroundColor = colorFor(r.buyer_type);

        const popup = new mapboxgl.Popup({ closeButton:false, offset: 12 }).setHTML(
          `<div style="font-weight:700">${r.name}</div>
           <div style="font-size:12px;opacity:.8">${labelFor(r.buyer_type)}</div>`
        );

        const marker = new mapboxgl.Marker({ element: el, anchor:'center' })
          .setLngLat(coords)
          .setPopup(popup)
          .addTo(map);

        el.addEventListener('mouseenter', ()=> marker.togglePopup());
        el.addEventListener('mouseleave', ()=> marker.togglePopup());

        markerById.set(r.id, { marker, popup, coords });
      });
    }

    /* ===================== UI WIRING ===================== */
    const tBuy=document.getElementById('tab-buyers');
    const tHome=document.getElementById('tab-homefull');
    const tSni=document.getElementById('tab-sniping');
    const tList=document.getElementById('tab-list');
    function setActive(){
      tBuy.classList.toggle('active',mode==='buyers');
      tHome.classList.toggle('active',mode==='homefull');
      tSni.classList.toggle('active',mode==='sniping');
      tList.classList.toggle('active',mode==='list');
      document.getElementById('modeChip').textContent =
        mode==='buyers'?'Buyer Search':(mode==='homefull'?'Homefull':(mode==='sniping'?'Wholesaler Sniping':'Buyers List'));
      document.getElementById('metricTiles').style.display = (mode==='buyers')?'grid':'none';
      document.getElementById('bulkbar').style.display = (mode==='buyers')?'flex':'none';
      document.getElementById('sortbar').style.display = (mode==='buyers')?'flex':'none';
      document.getElementById('results').style.display = (mode==='list')?'none':'block';
      document.getElementById('buyersListView').style.display = (mode==='list')?'block':'none';
    }
    tBuy.onclick=()=>{mode='buyers'; setActive(); refreshAll(false);}
    tHome.onclick=()=>{mode='homefull'; setActive(); refreshAll(false);}
    tSni.onclick=()=>{mode='sniping'; setActive(); refreshAll(false);}
    tList.onclick=()=>{mode='list'; setActive(); renderBuyersList();}

    // profile menu
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    profileBtn.onclick = ()=>{ profileMenu.style.display = profileMenu.style.display==='block'?'none':'block'; }
    document.addEventListener('click',(e)=>{
      if(!profileBtn.contains(e.target) && !profileMenu.contains(e.target)){ profileMenu.style.display='none'; }
    });
    // avatar init
    const avatar = document.getElementById('avatar');
    function refreshAvatar(){
      const initials = (user.name || 'Flip Radar').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
      avatar.textContent = initials;
    }
    refreshAvatar();

    // menu actions
    document.getElementById('miLogin').onclick = ()=>{
      const name = prompt('Enter your name (for profile bubble):', user.name || '');
      if(name!==null){
        user.name=name.trim();
        localStorage.setItem('user_name', user.name);
        refreshAvatar();
      }
      profileMenu.style.display='none';
    };
    document.getElementById('miLogout').onclick = ()=>{
      user.name='';
      localStorage.removeItem('user_name');
      refreshAvatar();
      profileMenu.style.display='none';
    };

    // settings drawer
    const drawer = document.getElementById('drawer');
    document.getElementById('miSettings').onclick = ()=>{
      document.getElementById('wh-batch').value = settings.batch;
      document.getElementById('wh-email').value = settings.email;
      document.getElementById('wh-sms').value = settings.sms;
      document.getElementById('wh-rvm').value = settings.rvm;
      document.getElementById('wh-crm').value = settings.crm;
      document.getElementById('wh-apollo').value = settings.apollo;
      drawer.classList.add('open');
      profileMenu.style.display='none';
    };
    document.getElementById('saveSettings').onclick = ()=>{
      settings.batch = document.getElementById('wh-batch').value.trim();
      settings.email = document.getElementById('wh-email').value.trim();
      settings.sms   = document.getElementById('wh-sms').value.trim();
      settings.rvm   = document.getElementById('wh-rvm').value.trim();
      settings.crm   = document.getElementById('wh-crm').value.trim();
      settings.apollo= document.getElementById('wh-apollo').value.trim();
      localStorage.setItem('wh_batch',settings.batch);
      localStorage.setItem('wh_email',settings.email);
      localStorage.setItem('wh_sms',settings.sms);
      localStorage.setItem('wh_rvm',settings.rvm);
      localStorage.setItem('wh_crm',settings.crm);
      localStorage.setItem('wh_apollo',settings.apollo);
      drawer.classList.remove('open');
      alert('Settings saved.');
    };
    // close drawer on ESC
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') drawer.classList.remove('open'); });

    document.getElementById('darkToggle').onclick = ()=>{
      document.body.classList.toggle('dark');
      switchStyle();
    };

    const milesSel = document.getElementById('miles');
    const monthsSel = document.getElementById('months');
    milesSel.onchange = e=>{ miles=parseFloat(e.target.value); refreshAll(true); };
    monthsSel.onchange = e=>{ months=parseInt(e.target.value,10); refreshAll(false); };

    // sort
    document.getElementById('sortBy').onchange = (e)=>{ sortBy = e.target.value; refreshAll(false); };

    // search & autocomplete
    const ac=document.getElementById('ac');
    const search=document.getElementById('search');
    document.getElementById('searchBtn').onclick = ()=> doSearch(search.value);
    search.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(search.value); });
    let acTimer=null;
    search.addEventListener('input', ()=>{
      const q=search.value.trim();
      if(!q || q.length<3){ ac.style.display='none'; ac.innerHTML=''; return; }
      clearTimeout(acTimer);
      acTimer=setTimeout(()=>{
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${MAPBOX_TOKEN}&autocomplete=true&limit=5&country=us`)
          .then(r=>r.json()).then(d=>{
            const feats=d.features||[];
            if(!feats.length){ ac.style.display='none'; ac.innerHTML=''; return; }
            ac.innerHTML = feats.map((f,i)=>`<button data-i="${i}">${f.place_name}</button>`).join('');
            ac.style.display='block';
            Array.from(ac.querySelectorAll('button')).forEach((b,idx)=>{
              b.onclick = ()=> doSearch(feats[idx].place_name);
            });
          }).catch(()=>{});
      }, 200);
    });
    function doSearch(q){
      const s=q.trim(); if(!s) return;
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(s)}.json?access_token=${MAPBOX_TOKEN}&limit=1&country=us`)
        .then(r=>r.json()).then(d=>{
          const f=d.features?.[0]; if(!f) return;
          const [lon,lat]=f.center; center={lat,lon};
          search.value=f.place_name; ac.style.display='none'; ac.innerHTML='';
          refreshAll(true);
        }).catch(()=>{});
    }

    /* ===================== REGISTERED AGENT LOOKUP ===================== */
    async function fetchRegisteredAgent(companyName, stateCode){ // stateCode like 'us_tx'
      try{
        const url = `https://api.opencorporates.com/v0.4/companies/search?q=${encodeURIComponent(companyName)}&jurisdiction_code=${encodeURIComponent(stateCode)}`;
        const r = await fetch(url);
        if(!r.ok) return null;
        const j = await r.json();
        const c = j?.results?.companies?.[0]?.company;
        const agent = c?.registered_agent_name || c?.agent_name || null;
        return agent;
      }catch{ return null; }
    }

    /* ===================== RENDER ===================== */
    const resultsDiv = document.getElementById('results');
    const selectAllEl = document.getElementById('selectAll');
    const bulkBtn = document.getElementById('bulkSkip');
    const resultCountEl = document.getElementById('resultCount');

    function updateBulkUI(){
      bulkBtn.disabled = selected.size===0;
      const total = resultsDiv.querySelectorAll('.row[data-id]').length||0;
      selectAllEl.indeterminate = selected.size>0 && selected.size < total;
      selectAllEl.checked = total>0 && selected.size === total;
    }

    selectAllEl.addEventListener('change', ()=>{
      const check = selectAllEl.checked;
      selected.clear();
      resultsDiv.querySelectorAll('input[type="checkbox"][data-id]').forEach(cb=>{
        cb.checked = check;
        if(check) selected.add(cb.dataset.id);
      });
      updateBulkUI();
    });

    bulkBtn.addEventListener('click', async ()=>{
      const ids = [...selected];
      if(!ids.length) return;
      if(!settings.batch){ alert('Add your BatchData webhook in Settings.'); return; }
      // Example POST; your worker will fan-out to BatchData with your secret key
      try{
        await fetch(settings.batch, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ ids }) });
        alert(`Submitted ${ids.length} contacts to Skip Trace webhook.`);
      }catch{
        alert('Failed to call webhook.');
      }
    });

    function sortResults(arr){
      if(sortBy==='distance'){
        arr.sort((a,b)=> a.dist - b.dist);
      }else if(sortBy==='score'){
        arr.sort((a,b)=> buyerScore(b,miles) - buyerScore(a,miles));
      }else if(sortBy==='contacted'){
        arr.sort((a,b)=> (b.contacted||0) - (a.contacted||0));
      }else if(sortBy==='recent'){
        arr.sort((a,b)=> b.last - a.last);
      }else if(sortBy==='deals'){
        arr.sort((a,b)=> b.deals - a.deals);
      }
      return arr;
    }

    function addToBuyersList(r){
      // attempt to pull city/state from nearest property used for last coord
      let city='', state='';
      if(r.coord){
        const p = properties.find(pp=>{
          const [lon,lat] = r.coord;
          return Math.abs(pp.lat - lat) < 0.0001 && Math.abs(pp.lon - lon) < 0.0001;
        });
        if(p){ city=p.city; state=p.state; }
      }
      const exist = savedBuyers.find(x=>x.id===r.id);
      if(!exist){
        savedBuyers.push({ id:r.id, name:r.name, type:r.buyer_type, city, state, vip:false, contacted:r.contacted||0 });
        localStorage.setItem('flipradar_list', JSON.stringify(savedBuyers));
        alert('Added to Buyers List.');
      }else{
        alert('Already in Buyers List.');
      }
    }

    function exportCSV(rows){
      const headers = ['id','name','type','city','state','vip','contacted'];
      const lines = [headers.join(',')].concat(rows.map(r=>[
        r.id, `"${r.name.replace(/"/g,'""')}"`, r.type, r.city||'', r.state||'', r.vip?1:0, r.contacted||0
      ].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'buyers_list.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function renderBuyersList(){
      const root = document.getElementById('buyersListView');
      root.innerHTML = `
        <div class="card" style="margin-bottom:10px">
          <div class="row-flex">
            <div class="grow"><input id="blFilter" class="input" placeholder="Filter buyers by name or city"/></div>
            <button id="blExport" class="btn btn-red">Export CSV</button>
            <button id="blCRM" class="btn btn-red">Export to CRM</button>
          </div>
        </div>
        <div class="card">
          <div style="display:grid;grid-template-columns:24px 1fr 120px 120px 80px 100px;gap:8px;padding:8px;font-weight:700;border-bottom:1px solid var(--line)">
            <div></div><div>Name</div><div>Type</div><div>Location</div><div>VIP</div><div>Contacted</div>
          </div>
          <div id="blRows"></div>
        </div>
      `;
      const rowsEl = root.querySelector('#blRows');
      function draw(filter=''){
        rowsEl.innerHTML='';
        const view = savedBuyers.filter(b=>{
          const f=filter.toLowerCase();
          return !f || b.name.toLowerCase().includes(f) || (b.city||'').toLowerCase().includes(f);
        });
        view.forEach(b=>{
          const row = document.createElement('div');
          row.style.display='grid';
          row.style.gridTemplateColumns='24px 1fr 120px 120px 80px 100px';
          row.style.gap='8px'; row.style.padding='8px'; row.style.borderBottom='1px solid var(--line)';
          row.innerHTML = `
            <div>🧾</div>
            <div>${b.name}</div>
            <div>${b.type}</div>
            <div>${[b.city,b.state].filter(Boolean).join(', ')}</div>
            <div><label style="display:flex;align-items:center;gap:6px"><input type="checkbox" ${b.vip?'checked':''}/> VIP</label></div>
            <div>${b.contacted||0}</div>
          `;
          const cb=row.querySelector('input[type="checkbox"]');
          cb.onchange=()=>{ b.vip=cb.checked; localStorage.setItem('flipradar_list', JSON.stringify(savedBuyers)); };
          rowsEl.appendChild(row);
        });
      }
      draw();
      root.querySelector('#blFilter').oninput = (e)=> draw(e.target.value);
      root.querySelector('#blExport').onclick = ()=> exportCSV(savedBuyers);
      root.querySelector('#blCRM').onclick = async ()=>{
        if(!settings.crm){ alert('Add your CRM webhook in Settings.'); return; }
        try{
          await fetch(settings.crm, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ buyers: savedBuyers })});
          alert('Exported to CRM webhook.');
        }catch{ alert('Failed to call CRM webhook.'); }
      };
    }

    async function onRegisteredAgentClick(name){
      // naive US/TX guess from demo — adjust if you know state
      const stateCode = 'us_tx';
      const btn = this;
      btn.disabled = true; btn.textContent='Fetching RA...';
      const agent = await fetchRegisteredAgent(name, stateCode);
      btn.textContent = agent ? `RA: ${agent}` : 'RA not found';
      setTimeout(()=>{ btn.disabled=false; btn.textContent='Get Contact Info'; }, 5000);
    }

    function refreshAll(fly){
      // chips
      document.getElementById('chipMiles').textContent=`${miles} mi`;
      document.getElementById('chipMonths').textContent=`${months} mo`;
      document.getElementById('tileMonthsA').textContent=months;
      document.getElementById('tileMonthsB').textContent=months;

      if(mode!=='buyers'){
        // non-buyer modes show stub panels
        resultsDiv.innerHTML='';
        selected.clear(); updateBulkUI();
        if(mode==='homefull'){
          resultsDiv.innerHTML=`
            <div class="row"><b>Homefull</b><div class="muted">AI-OCR on active & sold listings; agent leaderboard.</div></div>
            <div class="row">
              <div class="top"><div>506 Washington Blvd</div><span class="badge">Flip-Like 0.81</span></div>
              <div class="muted">Staged • LVP • Subway tile • Matte black</div>
              <div class="muted" style="margin-top:6px;">Agent: Leslie Elrod (432) 517-0038</div>
              <div class="actions"><button class="btn">Call Agent</button><button class="btn btn-red">Skiptrace Owner</button></div>
            </div>`;
        }else if(mode==='sniping'){
          resultsDiv.innerHTML=`
            <div class="row"><b>Wholesaler Sniping</b><div class="muted">Grantor → Grantee repeat pairs (last ${months} mo).</div></div>
            <div class="row">
              <div class="top"><div>ABC Investments LLC → Evergreen Homes LLC</div><span class="badge">6 in 12 mo</span></div>
              <div class="muted">last_deal: 2025-06-11</div>
              <div class="actions"><button class="btn">Skiptrace Buyer</button><button class="btn btn-red">+ Add to Buyers List</button></div>
            </div>`;
        }else if(mode==='list'){
          renderBuyersList();
        }
        // keep radius draw in all modes
        const radiusSrc=map.getSource('radius'); if(radiusSrc) radiusSrc.setData(circlePolygon(center.lon,center.lat,miles));
        if(fly) map.flyTo({center:[center.lon,center.lat], zoom:Math.max(map.getZoom(),11), essential:true});
        resultCountEl.textContent = '0';
        clearMarkers();
        return;
      }

      const res = computeResults(center,miles,months);
      resultCountEl.textContent = String(res.length);

      // metrics
      const avg=a=>Math.round((a.reduce((x,y)=>x+y,0))/(a.length||1));
      const flips=res.filter(r=>r.buyer_type==='Flipper').map(r=>r.median);
      const lands=res.filter(r=>r.buyer_type==='Landlord').map(r=>r.median);
      document.getElementById('avgFlip').textContent=`$${(flips.length?avg(flips):0).toLocaleString()}`;
      document.getElementById('avgLand').textContent=`$${(lands.length?avg(lands):0).toLocaleString()}`;

      // sort
      sortResults(res);

      // sidebar list
      selected.clear();
      resultsDiv.innerHTML='';
      if(!res.length){
        resultsDiv.innerHTML=`<div class="row muted">No active buyers found within ${miles} mi. Try widening the radius or time window.</div>`;
      }else{
        res.forEach(r=>{
          const color = r.buyer_type==='Flipper'?'blue':(r.buyer_type==='Landlord'?'green':'red');
          const score = buyerScore(r, miles);
          const scorePct = Math.max(0, Math.min(100, score));
          const row=document.createElement('div'); row.className='row'; row.dataset.id=r.id;
          row.innerHTML=`
            <div class="top" style="gap:10px">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" data-id="${r.id}"/>
                <div>${r.name}</div>
              </label>
              <span class="badge ${color}">${r.buyer_type}</span>
            </div>
            <div>
              <span class="badge" style="background:#e0f2fe;border-color:#e0f2fe;color:#075985;">📍 ${r.dist.toFixed(2)} mi</span>
              <span class="badge" style="margin-left:6px;background:${r.buyer_type==='Flipper'?'#3b82f6':'#22c55e'};border-color:${r.buyer_type==='Flipper'?'#3b82f6':'#22c55e'};color:#fff;">${r.deals} deals</span>
              <span class="muted"> Last: ${r.last.toLocaleDateString()}</span>
            </div>
            <div class="muted" style="margin-top:6px;">Median price: $${r.median.toLocaleString()}</div>
            <div class="temp-wrap" title="Buyer Score">
              <div class="temp-emoji">${tempEmoji(score)}</div>
              <div class="temp-track"><div class="temp-fill" style="width:${scorePct}%;"></div></div>
              <div style="min-width:44px;text-align:right;font-weight:700">${scorePct}%</div>
            </div>
            <div class="actions">
              <button class="btn" data-ra="1">Get Contact Info</button>
              <button class="btn btn-red" data-add="1">+ Add to Buyers List</button>
            </div>`;
          // hover a card → show popup + center map
          row.addEventListener('mouseenter', ()=>{
            const m = markerById.get(r.id); if(!m) return;
            m.marker.togglePopup(); map.easeTo({ center:m.coords, duration:600, zoom:Math.max(map.getZoom(),11) });
          });
          row.addEventListener('mouseleave', ()=>{
            const m = markerById.get(r.id); if(!m) return; m.marker.togglePopup();
          });
          // checkbox
          row.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
            const id = e.target.dataset.id;
            if(e.target.checked) selected.add(id); else selected.delete(id);
            updateBulkUI();
          });
          // RA button
          row.querySelector('[data-ra]').addEventListener('click', onRegisteredAgentClick.bind(row.querySelector('[data-ra]'), r.name));
          // Add to list
          row.querySelector('[data-add]').addEventListener('click', ()=> addToBuyersList(r));

          resultsDiv.appendChild(row);
        });
      }

      updateBulkUI();

      // markers + radius
      buildMarkers(res);
      const radiusSrc=map.getSource('radius'); if(radiusSrc) radiusSrc.setData(circlePolygon(center.lon,center.lat,miles));
      if(fly) map.flyTo({center:[center.lon,center.lat], zoom:Math.max(map.getZoom(),11), essential:true});
    }

    // initial tab & render
    setActive();
  </script>
</body>
</html>
